<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nano Banana Pro - AI åˆ†é•œç”Ÿæˆå™¨</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;700;900&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Serif SC', serif;
            background-color: #050505;
            color: #e5e5e5;
        }
        .mono { font-family: 'JetBrains Mono', monospace; }
        .storyboard-grid {
            background-image: 
                linear-gradient(rgba(255,255,255,0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255,255,255,0.03) 1px, transparent 1px);
            background-size: 20px 20px;
        }
        .shot-card {
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid #333;
            background: linear-gradient(135deg, #0a0a0a 0%, #111 100%);
        }
        .shot-card:hover {
            border-color: #555;
            transform: translateY(-2px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.8);
        }
        .shot-card.active {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90vw;
            max-width: 1200px;
            height: 90vh;
            z-index: 100;
            border: 2px solid #fff;
            box-shadow: 0 0 0 9999px rgba(0,0,0,0.9);
            cursor: default;
        }
        .shot-card.active .shot-image {
            height: 60%;
        }
        .generated-image {
            image-rendering: high-quality;
            filter: grayscale(100%) contrast(1.3) brightness(0.95);
        }
        .loading-scan {
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            animation: scan 1.5s infinite;
        }
        @keyframes scan {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        .grain {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            z-index: 50;
            opacity: 0.02;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
        }
        .close-btn {
            display: none;
            position: absolute;
            top: 20px;
            right: 20px;
            width: 40px;
            height: 40px;
            background: #fff;
            color: #000;
            border: none;
            font-size: 24px;
            cursor: pointer;
            z-index: 101;
            align-items: center;
            justify-content: center;
        }
        .shot-card.active .close-btn {
            display: flex;
        }
        .edit-textarea {
            background: #000;
            border: 1px solid #444;
            color: #fff;
            width: 100%;
            padding: 8px;
            font-size: 12px;
            resize: vertical;
            min-height: 60px;
            font-family: inherit;
        }
        .edit-textarea:focus {
            border-color: #fff;
            outline: none;
        }
        .btn-icon {
            background: transparent;
            border: 1px solid #555;
            color: #aaa;
            padding: 4px 8px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-icon:hover {
            border-color: #fff;
            color: #fff;
        }
        .btn-refresh {
            background: #fff;
            color: #000;
            border: none;
        }
        .btn-refresh:hover {
            background: #ccc;
        }
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #fff;
            box-shadow: 0 0 0 2px rgba(255,255,255,0.1);
        }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #0a0a0a; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
    </style>
</head>
<body class="min-h-screen storyboard-grid">
    <div class="grain"></div>
    
    <!-- Header -->
    <header class="border-b border-neutral-800 bg-black/90 backdrop-blur-md sticky top-0 z-40">
        <div class="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-white text-black flex items-center justify-center font-black text-xl mono border-2 border-white">N</div>
                <div>
                    <h1 class="text-xl font-black tracking-tight">NANO BANANA<span class="text-neutral-500">_PRO</span></h1>
                    <p class="text-xs text-neutral-500 mono">AI STORYBOARD GENERATOR</p>
                </div>
            </div>
            <div class="flex items-center gap-4">
                <div class="text-right hidden sm:block">
                    <div class="text-xs text-neutral-500">API STATUS</div>
                    <div id="apiStatus" class="text-xs text-neutral-600 mono">CHECKING...</div>
                </div>
                <button onclick="exportStoryboard()" class="px-4 py-2 bg-white text-black font-bold hover:bg-neutral-200 transition-all active:scale-95 text-sm border border-white">
                    å¯¼å‡ºåˆ†é•œ
                </button>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-6 py-8 flex flex-col lg:flex-row gap-8">
        <!-- Control Panel -->
        <div class="lg:w-1/3 space-y-6">
            
            <!-- API Configuration -->
            <div class="border border-neutral-800 bg-neutral-900/50 p-6 space-y-4">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-sm font-bold text-neutral-400 uppercase tracking-widest">API é…ç½®</h2>
                    <span class="text-xs text-neutral-600 mono">APIæ˜“</span>
                </div>
                
                <div>
                    <label class="block text-xs text-neutral-500 mb-2 uppercase tracking-wider flex justify-between">
                        <span>API Key</span>
                        <span class="text-neutral-700">å¿…å¡«</span>
                    </label>
                    <input type="password" id="apiKey" placeholder="è¾“å…¥ APIæ˜“ çš„ Key..." 
                        class="w-full bg-black border border-neutral-700 p-3 text-white placeholder-neutral-600 focus:border-white transition-colors mono text-sm">
                    <p class="text-xs text-neutral-600 mt-1">æ‚¨çš„ Key ä»…å­˜å‚¨åœ¨æœ¬åœ°æµè§ˆå™¨ä¸­</p>
                </div>

                <div>
                    <label class="block text-xs text-neutral-500 mb-2 uppercase tracking-wider">AI ç”Ÿå›¾æ¨¡å‹</label>
                    <select id="aiModel" class="w-full bg-black border border-neutral-700 p-3 text-white focus:border-white transition-colors text-sm">
                        <option value="gemini-3-pro-image-preview">Nano Banana Pro (Gemini 3)</option>
                        <option value="qwen-image-2512">Qwen-Image-2512 (é€šä¹‰åƒé—®)</option>
                    </select>
                </div>

                <div>
                    <label class="block text-xs text-neutral-500 mb-2 uppercase tracking-wider">API èŠ‚ç‚¹</label>
                    <select id="apiEndpoint" class="w-full bg-black border border-neutral-700 p-3 text-white focus:border-white transition-colors text-sm">
                        <option value="https://api.apiyi.com/v1">api.apiyi.com (æ™®é€š)</option>
                        <option value="https://vip.apiyi.com/v1" selected>vip.apiyi.com (æ¨è)</option>
                    </select>
                </div>

                <div>
                    <label class="block text-xs text-neutral-500 mb-2 uppercase tracking-wider">ç”Ÿæˆæ¨¡å¼</label>
                    <select id="generateMode" class="w-full bg-black border border-neutral-700 p-3 text-white focus:border-white transition-colors text-sm">
                        <option value="sequential" selected>é¡ºåºç”Ÿæˆ (ç¨³å®š)</option>
                        <option value="parallel">å¹¶è¡Œç”Ÿæˆ (å¿«é€Ÿ)</option>
                    </select>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-xs text-neutral-500 mb-2 uppercase tracking-wider">åˆ†è¾¨ç‡</label>
                        <select id="resolution" class="w-full bg-black border border-neutral-700 p-3 text-white focus:border-white transition-colors text-sm">
                            <option value="1024x1024">1K (1024Â²)</option>
                            <option value="1024x1024" selected>2K (1024Â²)</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs text-neutral-500 mb-2 uppercase tracking-wider">æ¯”ä¾‹</label>
                        <select id="aspectRatio" class="w-full bg-black border border-neutral-700 p-3 text-white focus:border-white transition-colors text-sm">
                            <option value="1:1">1:1 æ–¹å½¢</option>
                            <option value="16:9" selected>16:9 å®½å±</option>
                            <option value="9:16">9:16 ç«–å±</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Script Input -->
            <div class="border border-neutral-800 bg-neutral-900/50 p-6 space-y-4">
                <h2 class="text-sm font-bold text-neutral-400 uppercase tracking-widest mb-4">å‰§æœ¬è¾“å…¥</h2>
                
                <div>
                    <label class="block text-xs text-neutral-500 mb-2 uppercase tracking-wider">ç‰‡å</label>
                    <input type="text" id="projectTitle" placeholder="è¾“å…¥ç‰‡å..." 
                        class="w-full bg-black border border-neutral-700 p-3 text-white placeholder-neutral-600 focus:border-white transition-colors">
                </div>

                <div>
                    <label class="block text-xs text-neutral-500 mb-2 uppercase tracking-wider">åœºæ™¯æè¿°</label>
                    <input type="text" id="sceneDesc" placeholder="ä¾‹å¦‚ï¼šå†…æ™¯ å’–å•¡é¦† å¤œ" 
                        class="w-full bg-black border border-neutral-700 p-3 text-white placeholder-neutral-600 focus:border-white transition-colors">
                </div>

                <div>
                    <label class="block text-xs text-neutral-500 mb-2 uppercase tracking-wider flex justify-between">
                        <span>å‰§æœ¬å†…å®¹</span>
                        <button onclick="loadExample()" class="text-xs text-neutral-400 hover:text-white underline">åŠ è½½ç¤ºä¾‹</button>
                    </label>
                    <textarea id="scriptInput" rows="10" placeholder="åœ¨æ­¤è¾“å…¥å‰§æœ¬ï¼Œæ ¼å¼ï¼š
é•œå¤´1 ç‰¹å†™ å’–å•¡æ¯ä¸­çš„æ¶Ÿæ¼ª
æœåŠ¡å‘˜ï¼šæ‚¨çš„å’–å•¡å¥½äº†ã€‚

é•œå¤´2 ä¸­æ™¯ ç”·äººæŠ¬å¤´
ç”·äººï¼šè°¢è°¢ã€‚" 
                        class="w-full bg-black border border-neutral-700 p-3 text-white placeholder-neutral-600 focus:border-white transition-colors mono text-sm leading-relaxed resize-y"></textarea>
                </div>

                <button onclick="generateStoryboard()" id="generateBtn"
                    class="w-full py-3 bg-white text-black font-bold hover:bg-neutral-200 transition-all active:scale-95 flex items-center justify-center gap-2">
                    <span>ç”Ÿæˆåˆ†é•œç¨¿</span>
                    <span class="mono text-xs opacity-50">â†’</span>
                </button>
            </div>

            <!-- Tips -->
            <div class="border border-neutral-800 bg-neutral-900/30 p-4 text-xs text-neutral-500 space-y-2">
                <p class="font-bold text-neutral-400 flex items-center gap-2">
                    <span class="w-1 h-1 bg-white rounded-full"></span>
                    ä½¿ç”¨è¯´æ˜
                </p>
                <p>â€¢ ç‚¹å‡»åˆ†é•œæ¡†å¯æ”¾å¤§æŸ¥çœ‹å’Œç¼–è¾‘</p>
                <p>â€¢ æ”¾å¤§åå¯ç¼–è¾‘æè¿°å¹¶é‡æ–°ç”Ÿæˆ</p>
                <p>â€¢ é¡ºåºç”Ÿæˆï¼šé€ä¸ªç”Ÿæˆï¼Œæ›´ç¨³å®š</p>
                <p>â€¢ ç»Ÿä¸€é£æ ¼ï¼šç²—é»‘è½®å»“çº¿ + å¼ºçƒˆæ˜æš—å¯¹æ¯”</p>
            </div>
        </div>

        <!-- Preview Panel -->
        <div class="lg:w-2/3">
            <div id="storyboardContainer" class="space-y-6">
                <!-- Empty State -->
                <div class="border-2 border-dashed border-neutral-800 p-16 text-center text-neutral-600 bg-black/20">
                    <div class="text-5xl mb-4 opacity-30">ğŸ¬</div>
                    <p class="text-lg mb-2 font-bold">ç­‰å¾…ç”Ÿæˆ</p>
                    <p class="text-sm max-w-md mx-auto">åœ¨å·¦ä¾§é…ç½® API Key å¹¶è¾“å…¥å‰§æœ¬å†…å®¹ï¼ŒAI å°†è‡ªåŠ¨ä¸ºæ¯ä¸ªé•œå¤´ç”Ÿæˆç»Ÿä¸€é£æ ¼çš„é»‘ç™½åˆ†é•œçº¿ç¨¿å›¾</p>
                </div>
            </div>
        </div>
    </main>

    <script>
        let currentShots = [];
        let isGenerating = false;
        let activeCard = null;

        // ç»Ÿä¸€çš„é£æ ¼æç¤ºè¯
        const STYLE_PROMPT = `Rough black-and-white storyboard sketches, heavy and bold black outlines, strong light and shadow contrast, high-contrast shadows, loose gesture lines, cinematic composition, film aesthetics, Photoshop brush texture, quick sketch style, dramatic light and shadow separation`;

        // æ¨¡å‹é…ç½®
        const MODEL_CONFIG = {
            'gemini-3-pro-image-preview': { 
                name: 'Nano Banana Pro', 
                timeout: 120000
            },
            'qwen-image-2512': { 
                name: 'Qwen-Image-2512', 
                timeout: 120000
            }
        };

        function loadExample() {
            document.getElementById('projectTitle').value = 'ã€Šé›¨å¤œè¿½è¸ªã€‹';
            document.getElementById('sceneDesc').value = 'å†…æ™¯ å¤å¤å’–å•¡é¦† é›¨å¤œ';
            document.getElementById('scriptInput').value = `é•œå¤´1 å…¨æ™¯ é›¨å¤œè¡—é“ï¼Œéœ“è™¹ç¯åœ¨æ¹¿æ¼‰æ¼‰çš„åœ°é¢ä¸Šåå°„ï¼Œä¸€è¾†é»‘è‰²è½¿è½¦ç¼“ç¼“é©¶è¿‡
é•œå¤´2 ç‰¹å†™ å’–å•¡é¦†é—¨æŠŠæ‰‹ï¼Œä¸€åªæˆ´ç€é»‘è‰²çš®æ‰‹å¥—çš„æ‰‹æ¡ä½å®ƒ
é•œå¤´3 ä¸­æ™¯ é—¨è¢«æ¨å¼€ï¼Œé£è¡£ç”·å­èµ°å…¥ï¼ŒæŠ–è½é›¨ä¼ä¸Šçš„æ°´ç 
ç”·äººï¼šä¸€æ¯ç¾å¼ï¼Œä¸åŠ ç³–ã€‚
é•œå¤´4 è¿‘æ™¯ æœåŠ¡å‘˜æŠ¬å¤´ï¼Œçœ¼ç¥è­¦æƒ•ï¼Œæ‰‹ä¼¸å‘æŸœå°ä¸‹çš„æŠ¥è­¦å™¨
æœåŠ¡å‘˜ï¼šè¿™ä¹ˆæ™šäº†ï¼Œå…ˆç”Ÿæ‰¾è°ï¼Ÿ
é•œå¤´5 ç‰¹å†™ ç”·äººä»æ€€ä¸­æå‡ºæ³›é»„çš„ç…§ç‰‡æ”¾åœ¨æŸœå°ä¸Š
ç”·äººï¼šæˆ‘åœ¨æ‰¾è¿™ä¸ªäººã€‚`;
        }

        function parseScript() {
            const input = document.getElementById('scriptInput').value;
            if (!input.trim()) return [];

            const lines = input.split('\n').filter(line => line.trim());
            const shots = [];
            let currentShot = null;

            lines.forEach(line => {
                const shotMatch = line.match(/é•œå¤´\s*(\d+)\s*([^\n]*)/i);
                
                if (shotMatch) {
                    if (currentShot) shots.push(currentShot);
                    
                    const shotNum = shotMatch[1];
                    const content = shotMatch[2].trim();
                    
                    const sizes = ['ç‰¹å†™', 'è¿‘æ™¯', 'ä¸­æ™¯', 'å…¨æ™¯', 'è¿œæ™¯'];
                    let size = 'ä¸­æ™¯';
                    sizes.forEach(s => {
                        if (content.includes(s)) size = s;
                    });

                    currentShot = {
                        number: shotNum,
                        size: size,
                        description: content.replace(new RegExp(size), '').trim(),
                        dialogues: [],
                        action: '',
                        imageUrl: null,
                        status: 'pending'
                    };
                } else if (currentShot) {
                    const dialogueMatch = line.match(/^([^ï¼š:]+)[ï¼š:](.+)$/);
                    if (dialogueMatch) {
                        currentShot.dialogues.push({
                            character: dialogueMatch[1].trim(),
                            line: dialogueMatch[2].trim()
                        });
                    } else {
                        currentShot.action += (currentShot.action ? ' ' : '') + line.trim();
                    }
                }
            });

            if (currentShot) shots.push(currentShot);
            return shots;
        }

        async function generateStoryboard() {
            const apiKey = document.getElementById('apiKey').value.trim();
            if (!apiKey) {
                alert('è¯·è¾“å…¥ API Key');
                document.getElementById('apiKey').focus();
                return;
            }

            const title = document.getElementById('projectTitle').value || 'æœªå‘½åé¡¹ç›®';
            const scene = document.getElementById('sceneDesc').value || '';
            const generateMode = document.getElementById('generateMode').value;
            
            currentShots = parseScript();
            if (currentShots.length === 0) {
                alert('æœªèƒ½è§£æåˆ°é•œå¤´ä¿¡æ¯ï¼Œè¯·æ£€æŸ¥å‰§æœ¬æ ¼å¼');
                return;
            }

            isGenerating = true;
            document.getElementById('generateBtn').disabled = true;
            document.getElementById('generateBtn').innerHTML = '<span class="animate-pulse">ç”Ÿæˆä¸­...</span>';
            
            renderStoryboard(title, scene, true);
            
            if (generateMode === 'parallel') {
                await Promise.all(currentShots.map((_, i) => generateImageForShot(i, apiKey, scene)));
            } else {
                for (let i = 0; i < currentShots.length; i++) {
                    await generateImageForShot(i, apiKey, scene);
                    renderStoryboard(title, scene, true);
                }
            }
            
            renderStoryboard(title, scene, false);
            
            isGenerating = false;
            document.getElementById('generateBtn').disabled = false;
            document.getElementById('generateBtn').innerHTML = '<span>ç”Ÿæˆåˆ†é•œç¨¿</span><span class="mono text-xs opacity-50">â†’</span>';
        }

        async function regenerateShot(index) {
            const apiKey = document.getElementById('apiKey').value.trim();
            if (!apiKey) {
                alert('è¯·è¾“å…¥ API Key');
                return;
            }

            const scene = document.getElementById('sceneDesc').value || '';
            
            // è·å–ç¼–è¾‘åçš„æè¿°
            const editTextarea = document.getElementById(`edit-desc-${index}`);
            if (editTextarea) {
                currentShots[index].description = editTextarea.value.trim();
            }

            currentShots[index].status = 'generating';
            currentShots[index].imageUrl = null;
            renderStoryboard(document.getElementById('projectTitle').value || 'æœªå‘½åé¡¹ç›®', scene, true);
            
            await generateImageForShot(index, apiKey, scene);
            
            renderStoryboard(document.getElementById('projectTitle').value || 'æœªå‘½åé¡¹ç›®', scene, false);
        }

        async function generateImageForShot(index, apiKey, sceneContext) {
            const shot = currentShots[index];
            shot.status = 'generating';
            
            const baseUrl = document.getElementById('apiEndpoint').value;
            const model = document.getElementById('aiModel').value;
            const config = MODEL_CONFIG[model];
            
            for (let retry = 0; retry < 3; retry++) {
                try {
                    const prompt = `${shot.size} shot: ${shot.description}. ${shot.action}. Scene: ${sceneContext}. ${STYLE_PROMPT}`;
                    
                    console.log(`Generating shot ${shot.number} (attempt ${retry + 1}):`, prompt);

                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), config.timeout);

                    const response = await fetch(`${baseUrl}/images/generations`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${apiKey}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            model: model,
                            prompt: prompt,
                            n: 1,
                            size: '1024x1024',
                            quality: 'standard',
                            response_format: 'url'
                        }),
                        signal: controller.signal
                    });

                    clearTimeout(timeoutId);

                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error(`API Error (attempt ${retry + 1}):`, errorText);
                        
                        if (response.status === 429 || response.status === 503) {
                            const waitTime = (2 ** retry) * 1000;
                            console.log(`Rate limited, waiting ${waitTime}ms...`);
                            await new Promise(r => setTimeout(r, waitTime));
                            continue;
                        }
                        
                        throw new Error(`API Error ${response.status}`);
                    }

                    const data = await response.json();
                    console.log('Response:', data);
                    
                    if (data.data && data.data[0] && data.data[0].url) {
                        shot.imageUrl = data.data[0].url;
                        shot.status = 'completed';
                        return;
                    } 
                    else if (data.data && data.data[0] && data.data[0].b64_json) {
                        shot.imageUrl = `data:image/jpeg;base64,${data.data[0].b64_json}`;
                        shot.status = 'completed';
                        return;
                    }
                    else if (data.b64_json) {
                        shot.imageUrl = `data:image/jpeg;base64,${data.b64_json}`;
                        shot.status = 'completed';
                        return;
                    }
                    else {
                        throw new Error('No image data in response');
                    }
                } catch (error) {
                    console.error(`Error (attempt ${retry + 1}):`, error);
                    
                    if (retry === 2) {
                        shot.status = 'error';
                        shot.error = error.name === 'AbortError' ? 'è¯·æ±‚è¶…æ—¶' : error.message;
                    } else {
                        await new Promise(r => setTimeout(r, 1000));
                    }
                }
            }
        }

        function toggleCard(index) {
            const cards = document.querySelectorAll('.shot-card');
            const card = cards[index];
            
            if (activeCard === card) {
                closeActiveCard();
            } else {
                if (activeCard) {
                    activeCard.classList.remove('active');
                }
                card.classList.add('active');
                activeCard = card;
            }
        }

        function closeActiveCard(e) {
            if (e) e.stopPropagation();
            if (activeCard) {
                activeCard.classList.remove('active');
                activeCard = null;
            }
        }

        function renderStoryboard(title, scene, isLoading = false) {
            const container = document.getElementById('storyboardContainer');
            const timestamp = new Date().toLocaleDateString('zh-CN');
            const model = document.getElementById('aiModel').value;
            const modelName = MODEL_CONFIG[model].name;
            
            let html = `
                <div class="border-b-2 border-white pb-4 mb-8 flex justify-between items-end bg-black/50 p-4 backdrop-blur">
                    <div>
                        <h1 class="text-3xl font-black tracking-tight mb-1">${title}</h1>
                        <p class="text-neutral-500 text-sm mono">${scene}</p>
                    </div>
                    <div class="text-right text-xs text-neutral-600 mono">
                        <div>GENERATED: ${timestamp}</div>
                        <div>SHOTS: ${currentShots.length}</div>
                        <div>MODEL: ${modelName.toUpperCase()}</div>
                    </div>
                </div>
                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
            `;

            currentShots.forEach((shot, index) => {
                const sizeAbbr = {
                    'ç‰¹å†™': 'CU', 'è¿‘æ™¯': 'MCU', 'ä¸­æ™¯': 'MS', 
                    'å…¨æ™¯': 'FS', 'è¿œæ™¯': 'LS'
                }[shot.size] || 'MS';

                const statusColor = {
                    'pending': 'bg-neutral-800',
                    'generating': 'bg-blue-900/20 border-blue-500/50',
                    'completed': 'bg-neutral-900',
                    'error': 'bg-red-900/20 border-red-500/50'
                }[shot.status];

                // æ„å»ºå¯¹ç™½æ–‡æœ¬
                let dialogueHtml = '';
                if (shot.dialogues.length > 0) {
                    dialogueHtml = shot.dialogues.map(d => 
                        `<div class="mb-1"><span class="text-neutral-400">${d.character}:</span> "${d.line}"</div>`
                    ).join('');
                }

                html += `
                    <div class="shot-card ${statusColor} p-0 overflow-hidden relative" onclick="if(!this.classList.contains('active')) toggleCard(${index})">
                        <button class="close-btn" onclick="closeActiveCard(event)">Ã—</button>
                        ${shot.status === 'generating' ? '<div class="absolute inset-0 loading-scan z-10"></div>' : ''}
                        
                        <!-- Image Area -->
                        <div class="shot-image aspect-[4/3] bg-neutral-900 relative overflow-hidden border-b border-neutral-800 flex items-center justify-center">
                            ${shot.imageUrl ? `
                                <img src="${shot.imageUrl}" alt="Shot ${shot.number}" 
                                    class="w-full h-full object-cover generated-image opacity-90 hover:opacity-100 transition-opacity"
                                    onerror="this.parentElement.innerHTML='<div class=\'text-red-500 text-xs mono\'>LOAD FAILED</div>'">
                            ` : `
                                <div class="text-center p-4">
                                    ${shot.status === 'generating' ? 
                                        '<div class="animate-spin w-8 h-8 border-2 border-white border-t-transparent rounded-full mx-auto mb-2"></div><span class="text-xs mono text-neutral-500">...</span>' : 
                                        shot.status === 'error' ?
                                        `<div class="text-red-500 text-xs mono mb-1">ERROR</div><div class="text-neutral-600 text-xs scale-75">${shot.error}</div>` :
                                        '<span class="text-2xl opacity-20">ğŸ¬</span>'
                                    }
                                </div>
                            `}
                        </div>

                        <!-- Info Area (Small View) -->
                        <div class="small-info p-3 space-y-2">
                            <div class="flex justify-between items-center">
                                <div class="flex gap-2 items-center">
                                    <div class="w-8 h-8 border border-white flex items-center justify-center font-bold text-sm mono bg-black text-white">
                                        ${sizeAbbr}
                                    </div>
                                    <div class="text-xs font-bold">${shot.size}</div>
                                </div>
                                <div class="text-xs mono ${shot.status === 'error' ? 'text-red-500' : shot.status === 'completed' ? 'text-green-500' : 'text-neutral-600'}">
                                    ${shot.status === 'completed' ? 'âœ“' : shot.status === 'error' ? 'âœ—' : '...'}
                                </div>
                            </div>

                            <div class="text-xs text-neutral-400 line-clamp-2 leading-relaxed">
                                ${shot.description}
                            </div>

                            <div class="text-xs text-neutral-600 mono pt-1">
                                SHOT_${String(shot.number).padStart(2, '0')}
                            </div>
                        </div>

                        <!-- Expanded Info Area (Large View) -->
                        <div class="expanded-info hidden p-6 space-y-4 h-[40%] overflow-y-auto">
                            <div class="flex justify-between items-center border-b border-neutral-700 pb-3">
                                <div class="flex gap-3 items-center">
                                    <div class="w-10 h-10 border-2 border-white flex items-center justify-center font-bold text-lg mono bg-black text-white">
                                        ${sizeAbbr}
                                    </div>
                                    <div>
                                        <div class="text-xs text-neutral-500 uppercase">æ™¯åˆ«</div>
                                        <div class="font-bold">${shot.size}</div>
                                    </div>
                                </div>
                                <div class="text-xs mono text-neutral-500">
                                    SHOT_${String(shot.number).padStart(2, '0')}
                                </div>
                            </div>

                            <div>
                                <label class="text-xs text-neutral-500 uppercase mb-2 block">ç”»é¢æè¿°ï¼ˆå¯ç¼–è¾‘ï¼‰</label>
                                <textarea id="edit-desc-${index}" class="edit-textarea" rows="3">${shot.description}</textarea>
                            </div>

                            ${shot.action ? `
                                <div>
                                    <label class="text-xs text-neutral-500 uppercase mb-1 block">åŠ¨ä½œ</label>
                                    <div class="text-sm text-neutral-400 italic">${shot.action}</div>
                                </div>
                            ` : ''}

                            ${shot.dialogues.length > 0 ? `
                                <div>
                                    <label class="text-xs text-neutral-500 uppercase mb-2 block">å¯¹ç™½</label>
                                    <div class="text-sm text-neutral-300 space-y-1 bg-black/30 p-3 border border-neutral-800">
                                        ${dialogueHtml}
                                    </div>
                                </div>
                            ` : ''}

                            <div class="flex gap-2 pt-2">
                                <button onclick="regenerateShot(${index}); event.stopPropagation();" class="btn-icon btn-refresh flex-1 py-2 font-bold">
                                    â†» é‡æ–°ç”Ÿæˆ
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });

            html += '</div>';
            container.innerHTML = html;

            // æ¿€æ´»å±•å¼€è§†å›¾çš„æ˜¾ç¤ºé€»è¾‘
            document.querySelectorAll('.shot-card').forEach(card => {
                card.addEventListener('click', function(e) {
                    if (this.classList.contains('active')) {
                        this.querySelector('.small-info').style.display = 'none';
                        this.querySelector('.expanded-info').style.display = 'block';
                    }
                });
            });
        }

        function exportStoryboard() {
            if (currentShots.length === 0) {
                alert('è¯·å…ˆç”Ÿæˆåˆ†é•œç¨¿');
                return;
            }
            window.print();
        }

        // ESC é”®å…³é—­æ”¾å¤§
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeActiveCard();
            }
        });

        window.addEventListener('load', function() {
            document.getElementById('apiStatus').textContent = 'READY';
            document.getElementById('apiStatus').className = 'text-xs text-green-500 mono';
        });

        document.getElementById('apiKey').addEventListener('blur', function() {
            if (this.value) localStorage.setItem('nano_banana_api_key', this.value);
        });
        
        const saved = localStorage.getItem('nano_banana_api_key');
        if (saved) document.getElementById('apiKey').value = saved;
    </script>
</body>
</html>
