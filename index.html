<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI åˆ†é•œç”Ÿæˆå™¨ - Nano Banana Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;700;900&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        * {
            scrollbar-width: thin;
            scrollbar-color: #333 #0a0a0a;
        }
        body {
            font-family: 'Noto Serif SC', serif;
            background-color: #050505;
            color: #e5e5e5;
            overflow: hidden;
            font-size: 12px;
        }
        .mono { font-family: 'JetBrains Mono', monospace; }
        .storyboard-grid {
            background-image: 
                linear-gradient(rgba(255,255,255,0.02) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255,255,255,0.02) 1px, transparent 1px);
            background-size: 20px 20px;
        }

        .left-panel {
            height: 100vh;
            overflow-y: auto;
            overflow-x: hidden;
            padding-bottom: 100px;
        }
        .left-panel::-webkit-scrollbar { width: 4px; }
        .left-panel::-webkit-scrollbar-track { background: #0a0a0a; }
        .left-panel::-webkit-scrollbar-thumb { background: #333; border-radius: 2px; }

        .shot-card {
            transition: all 0.3s ease;
            border: 1px solid #333;
            background: linear-gradient(135deg, #0a0a0a 0%, #111 100%);
            position: relative;
        }
        .shot-card:hover {
            border-color: #555;
        }
        .shot-card:hover .delete-btn {
            opacity: 1;
        }

        .delete-btn {
            position: absolute;
            top: 4px;
            right: 4px;
            width: 20px;
            height: 20px;
            background: #dc2626;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
            line-height: 1;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 10;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .delete-btn:hover {
            background: #b91c1c;
        }

        .image-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0,0,0,0.95);
            z-index: 200;
            justify-content: center;
            align-items: center;
            cursor: zoom-out;
        }
        .image-modal.active { display: flex; }
        .image-modal img {
            max-width: 90vw;
            max-height: 90vh;
            object-fit: contain;
            cursor: default;
        }

        .drop-zone {
            border: 2px dashed #444;
            background: rgba(255,255,255,0.02);
            transition: all 0.3s;
        }
        .drop-zone.drag-over {
            border-color: #fff;
            background: rgba(255,255,255,0.08);
        }
        .drop-zone.success {
            border-color: #10b981;
            background: rgba(16, 185, 129, 0.1);
        }

        .reference-upload {
            border: 1px dashed #444;
            background: rgba(255,255,255,0.02);
            transition: all 0.2s;
            cursor: pointer;
            padding: 4px;
        }
        .reference-upload:hover {
            border-color: #666;
            background: rgba(255,255,255,0.04);
        }
        .reference-upload.has-image {
            border-color: #3b82f6;
            border-style: solid;
        }
        .reference-thumb {
            max-height: 40px;
            max-width: 100%;
            object-fit: contain;
        }

        .loading-scan {
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            animation: scan 1s infinite;
        }
        @keyframes scan {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .grain {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            z-index: 50;
            opacity: 0.02;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
        }

        .btn-primary {
            background: #fff;
            color: #000;
            border: none;
            padding: 8px 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 12px;
        }
        .btn-primary:hover:not(:disabled) { background: #ccc; }
        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: transparent;
            border: 1px solid #555;
            color: #aaa;
            padding: 4px 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 10px;
        }
        .btn-secondary:hover {
            border-color: #fff;
            color: #fff;
        }

        .btn-analyze {
            background: linear-gradient(135deg, #1a1a1a 0%, #0a0a0a 100%);
            border: 1px solid #444;
            color: #fff;
            padding: 8px 16px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 12px;
        }
        .btn-analyze:hover:not(:disabled) { border-color: #10b981; }
        .btn-analyze:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .edit-section {
            background: #0a0a0a;
            border: 1px solid #333;
            margin-bottom: 4px;
        }
        .edit-section-header {
            background: #1a1a1a;
            padding: 4px 8px;
            font-size: 9px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #888;
            border-bottom: 1px solid #333;
        }
        .edit-textarea {
            width: 100%;
            background: transparent;
            border: none;
            color: #e5e5e5;
            padding: 6px 8px;
            font-size: 11px;
            line-height: 1.4;
            resize: vertical;
            min-height: 35px;
            font-family: inherit;
        }
        .edit-textarea:focus {
            outline: none;
            background: rgba(255,255,255,0.02);
        }

        .control-group {
            background: #0a0a0a;
            border: 1px solid #333;
            padding: 8px;
            margin-bottom: 8px;
        }
        .control-label {
            font-size: 9px;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 6px;
            display: block;
        }

        .style-input {
            width: 100%;
            background: #111;
            border: 1px solid #333;
            color: #fff;
            padding: 6px 8px;
            font-size: 11px;
            margin-bottom: 6px;
            font-family: inherit;
        }
        .style-input:focus {
            outline: none;
            border-color: #555;
            background: #1a1a1a;
        }
        .style-input::placeholder {
            color: #555;
        }

        select, input[type="text"], input[type="password"] {
            width: 100%;
            background: #111;
            border: 1px solid #444;
            color: #fff;
            padding: 6px;
            font-size: 11px;
        }
        select:focus, input:focus {
            outline: none;
            border-color: #fff;
        }

        .masonry-grid {
            column-count: 3;
            column-gap: 12px;
        }
        @media (max-width: 1400px) {
            .masonry-grid { column-count: 2; }
        }
        @media (max-width: 900px) {
            .masonry-grid { column-count: 1; }
        }

        .style-tag {
            display: inline-block;
            padding: 2px 6px;
            background: #1a1a1a;
            border: 1px solid #333;
            font-size: 9px;
            color: #666;
            margin-right: 4px;
            margin-bottom: 4px;
        }
    </style>
<base target="_blank">
</head>
<body class="storyboard-grid">
    <div class="grain"></div>

    <div class="image-modal" id="imageModal" onclick="closeImageModal(event)">
        <img id="modalImage" src="" alt="æ”¾å¤§å›¾ç‰‡">
        <div style="position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); color: #666; font-size: 12px;">ç‚¹å‡»ä»»æ„å¤„å…³é—­</div>
    </div>

    <div class="flex h-screen">
        <!-- å·¦ä¾§å·¥ä½œæ  -->
        <div class="left-panel w-80 border-r border-neutral-800 bg-black/80 backdrop-blur">
            <div class="p-4 space-y-3">

                <!-- Header -->
                <div class="flex items-center gap-2 pb-3 border-b border-neutral-800">
                    <div class="w-8 h-8 bg-white text-black flex items-center justify-center font-black text-sm mono">N</div>
                    <div>
                        <h1 class="text-sm font-black tracking-tight">STORYBOARD<span class="text-neutral-500">_PRO</span></h1>
                        <p class="text-[10px] text-neutral-500 mono">NANO BANANA PRO</p>
                    </div>
                </div>

                <!-- API é…ç½® -->
                <div class="control-group">
                    <label class="control-label">API é…ç½®</label>
                    <input type="password" id="apiKey" placeholder="è¾“å…¥ APIæ˜“ Key..." class="mb-2">
                    <select id="apiEndpoint">
                        <option value="https://api.apiyi.com/v1" selected>api.apiyi.com</option>
                        <option value="https://vip.apiyi.com/v1">vip.apiyi.com</option>
                    </select>
                </div>

                <!-- ç”»é¢æ¯”ä¾‹ -->
                <div class="control-group">
                    <label class="control-label">ç”»é¢æ¯”ä¾‹</label>
                    <select id="aspectRatio">
                        <option value="16:9" selected>16:9 å®½å±</option>
                        <option value="4:3">4:3 æ ‡å‡†</option>
                        <option value="2.39:1">2.39:1 è¶…å®½</option>
                        <option value="9:16">9:16 ç«–å±</option>
                        <option value="1:1">1:1 æ–¹å½¢</option>
                    </select>
                </div>

                <!-- ç”»é¢è´¨é‡ -->
                <div class="control-group">
                    <label class="control-label">ç”»é¢è´¨é‡</label>
                    <select id="imageQuality">
                        <option value="1024x1024" selected>1K (å¿«é€Ÿ)</option>
                        <option value="1024x1024">2K (æ ‡å‡†)</option>
                        <option value="1024x1024">4K (é«˜æ¸…)</option>
                    </select>
                </div>

                <!-- å‰§æœ¬ä¸Šä¼  -->
                <div class="space-y-1">
                    <label class="control-label">å‰§æœ¬ä¸Šä¼ </label>
                    <div class="drop-zone p-3 text-center rounded cursor-pointer" id="dropZone">
                        <div class="text-lg mb-1" id="dropIcon">ğŸ“„</div>
                        <p class="text-xs text-neutral-400" id="dropText">æ‹–æ‹½ Word æ–‡æ¡£</p>
                        <p class="text-[10px] text-neutral-600" id="dropSubtext">.docx / .txt</p>
                        <input type="file" id="fileInput" accept=".docx,.doc,.txt" class="hidden">
                    </div>
                </div>

                <!-- AI è§£ææŒ‰é’® -->
                <button onclick="analyzeScript()" id="analyzeBtn" disabled class="btn-analyze w-full">
                    <span id="analyzeBtnText">ğŸ§  AI è§£æ</span>
                </button>

                <!-- ç”»é¢é£æ ¼æè¿° -->
                <div class="control-group">
                    <label class="control-label">ç”»é¢é£æ ¼æè¿°</label>
                    <input type="text" id="eraBackground" class="style-input" placeholder="æ—¶ä»£èƒŒæ™¯ (å¦‚ï¼šæ°‘å›½æ—¶æœŸã€æœªæ¥ç§‘å¹»...)">
                    <input type="text" id="atmosphere" class="style-input" placeholder="æ°›å›´åŸºè°ƒ (å¦‚ï¼šå‹æŠ‘ç´§å¼ ã€æ¸©é¦¨æµªæ¼«...)">
                    <input type="text" id="colorTone" class="style-input" placeholder="è‰²å½©å€¾å‘ (å¦‚ï¼šå†·è‰²è°ƒé’è“ã€æš–è‰²è°ƒé‡‘é»„...)">
                    <input type="text" id="lightingQuality" class="style-input" placeholder="å…‰å½±è´¨æ„Ÿ (å¦‚ï¼šç¡¬å…‰å‰ªå½±ã€æŸ”å’Œæ•£å°„...)">
                </div>

                <!-- é¡¹ç›®ä¿¡æ¯ -->
                <div class="control-group">
                    <label class="control-label">é¡¹ç›®ä¿¡æ¯</label>
                    <input type="text" id="projectTitle" placeholder="ç‰‡å..." class="mb-2">
                    <input type="text" id="sceneDesc" placeholder="åœºæ™¯æè¿°...">
                </div>

                <!-- ç”ŸæˆæŒ‰é’® -->
                <button onclick="generateStoryboard()" id="generateBtn" disabled class="btn-primary w-full">
                    ç”Ÿæˆåˆ†é•œç¨¿
                </button>

                <!-- ä½¿ç”¨è¯´æ˜ -->
                <div class="text-[10px] text-neutral-600 space-y-1 pt-3 border-t border-neutral-800">
                    <p>â€¢ ç”»é¢é£æ ¼ä¼šå½±å“æ‰€æœ‰åˆ†é•œç”Ÿæˆ</p>
                    <p>â€¢ æ¯ä¸ªé•œå¤´ï¼šè¿é•œ/ç”»é¢/éŸ³æ•ˆ</p>
                    <p>â€¢ å¯ä¸Šä¼ å‚è€ƒå›¾è¿›è¡Œå›¾ç”Ÿå›¾</p>
                </div>
            </div>
        </div>

        <!-- å³ä¾§åˆ†é•œé¢„è§ˆåŒº -->
        <div class="flex-1 h-screen overflow-y-auto p-4" id="rightPanel">
            <div id="storyboardContainer" class="space-y-4">
                <div class="flex flex-col items-center justify-center h-full text-neutral-600 min-h-[60vh]">
                    <div class="text-4xl mb-3 opacity-20">ğŸ¬</div>
                    <p class="text-sm mb-1">ç­‰å¾…å‰§æœ¬</p>
                    <p class="text-xs text-center">æ‹–æ‹½ Word æ–‡æ¡£ä¸Šä¼ </p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentShots = [];
        let isGenerating = false;
        let rawScriptText = '';

        const BASE_STYLE = `Rough black-and-white storyboard sketches, heavy and bold black outlines, strong light and shadow contrast, high-contrast shadows, loose gesture lines, cinematic composition, film aesthetics, Photoshop brush texture, quick sketch style, dramatic light and shadow separation`;

        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');

        dropZone.addEventListener('click', () => fileInput.click());

        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        dropZone.addEventListener('dragenter', () => dropZone.classList.add('drag-over'));
        dropZone.addEventListener('dragleave', () => dropZone.classList.remove('drag-over'));

        dropZone.addEventListener('drop', (e) => {
            dropZone.classList.remove('drag-over');
            const files = e.dataTransfer.files;
            if (files.length > 0) handleFile(files[0]);
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) handleFile(e.target.files[0]);
        });

        async function handleFile(file) {
            const dropIcon = document.getElementById('dropIcon');
            const dropText = document.getElementById('dropText');
            const dropSubtext = document.getElementById('dropSubtext');

            dropZone.classList.add('drag-over');

            try {
                let text = '';
                if (file.name.endsWith('.docx') || file.name.endsWith('.doc')) {
                    const arrayBuffer = await file.arrayBuffer();
                    const result = await mammoth.extractRawText({ arrayBuffer });
                    text = result.value;
                } else {
                    text = await file.text();
                }

                rawScriptText = text;

                dropZone.classList.remove('drag-over');
                dropZone.classList.add('success');
                dropIcon.textContent = 'âœ…';
                dropText.textContent = file.name;
                dropSubtext.textContent = `${(file.size/1024).toFixed(1)} KB`;
                document.getElementById('analyzeBtn').disabled = false;

                const titleMatch = text.match(/^(.*?)(?:\n|å‰§æœ¬|æ•…äº‹)/);
                if (titleMatch && !document.getElementById('projectTitle').value) {
                    document.getElementById('projectTitle').value = titleMatch[1].trim().substring(0, 30);
                }
            } catch (error) {
                dropZone.classList.remove('drag-over');
                dropIcon.textContent = 'âŒ';
                dropText.textContent = 'å¤±è´¥';
                dropSubtext.textContent = 'é‡è¯•';
            }
        }

        // è§£æå‰§æœ¬ - åŒæ—¶åˆ†æç”»é¢é£æ ¼
        async function analyzeScript() {
            const apiKey = document.getElementById('apiKey').value.trim();
            if (!apiKey) { alert('è¯·è¾“å…¥ API Key'); return; }
            if (!rawScriptText) { alert('è¯·å…ˆä¸Šä¼ å‰§æœ¬'); return; }

            const btn = document.getElementById('analyzeBtn');
            const btnText = document.getElementById('analyzeBtnText');
            btn.disabled = true;
            btnText.textContent = 'åˆ†æä¸­...';

            try {
                const baseUrl = document.getElementById('apiEndpoint').value;

                const response = await fetch(`${baseUrl}/chat/completions`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: 'gemini-2.5-pro-preview-03-25',
                        messages: [{
                            role: 'user',
                            content: `åˆ†æå‰§æœ¬ï¼Œæå–ç”»é¢é£æ ¼å’Œåˆ†é•œå¤´ã€‚è¿”å›JSONï¼š\n\n${rawScriptText.substring(0, 8000)}\n\næ ¼å¼ï¼š{\n  "title": "ç‰‡å",\n  "scene": "åœºæ™¯",\n  "visualStyle": {\n    "era": "æ—¶ä»£èƒŒæ™¯",\n    "atmosphere": "æ°›å›´åŸºè°ƒ",\n    "color": "è‰²å½©å€¾å‘",\n    "lighting": "å…‰å½±è´¨æ„Ÿ"\n  },\n  "shots": [{\n    "number": "01",\n    "camera": "è¿é•œ",\n    "content": "ç”»é¢",\n    "audio": "éŸ³æ•ˆ"\n  }]\n}\nåªè¿”å›JSONã€‚`
                        }],
                        temperature: 0.7
                    })
                });

                if (!response.ok) throw new Error(`HTTP ${response.status}`);

                const data = await response.json();
                const content = data.choices[0].message.content;
                const jsonMatch = content.match(/\{[\s\S]*\}/);

                if (jsonMatch) {
                    const parsed = JSON.parse(jsonMatch[0]);
                    applyParsedScript(parsed);
                }
            } catch (error) {
                alert('è§£æå¤±è´¥: ' + error.message);
                btn.disabled = false;
                btnText.textContent = 'ğŸ§  AI è§£æ';
            }
        }

        function applyParsedScript(data) {
            if (data.title) document.getElementById('projectTitle').value = data.title;
            if (data.scene) document.getElementById('sceneDesc').value = data.scene;

            // å¡«å……ç”»é¢é£æ ¼
            if (data.visualStyle) {
                if (data.visualStyle.era) document.getElementById('eraBackground').value = data.visualStyle.era;
                if (data.visualStyle.atmosphere) document.getElementById('atmosphere').value = data.visualStyle.atmosphere;
                if (data.visualStyle.color) document.getElementById('colorTone').value = data.visualStyle.color;
                if (data.visualStyle.lighting) document.getElementById('lightingQuality').value = data.visualStyle.lighting;
            }

            if (data.shots) {
                currentShots = data.shots.map((shot, idx) => ({
                    id: Date.now() + idx,
                    number: shot.number || String(idx + 1).padStart(2, '0'),
                    camera: shot.camera || '',
                    content: shot.content || '',
                    audio: shot.audio || '',
                    referenceImage: null,
                    generatedImage: null,
                    status: 'pending'
                }));

                document.getElementById('generateBtn').disabled = false;
                document.getElementById('analyzeBtnText').textContent = `âœ… ${currentShots.length}ä¸ªé•œå¤´`;

                renderStoryboard();
            }
        }

        // æ„å»ºé£æ ¼æç¤ºè¯
        function buildStylePrompt() {
            const era = document.getElementById('eraBackground').value || '';
            const atmosphere = document.getElementById('atmosphere').value || '';
            const color = document.getElementById('colorTone').value || '';
            const lighting = document.getElementById('lightingQuality').value || '';

            let stylePrompt = BASE_STYLE;

            if (era) stylePrompt += `, ${era} era setting`;
            if (atmosphere) stylePrompt += `, ${atmosphere} atmosphere`;
            if (color) stylePrompt += `, ${color} color palette`;
            if (lighting) stylePrompt += `, ${lighting} lighting`;

            return stylePrompt;
        }

        // åˆ é™¤åˆ†é•œ
        function deleteShot(index) {
            if (confirm('ç¡®å®šåˆ é™¤è¿™ä¸ªé•œå¤´å—ï¼Ÿ')) {
                currentShots.splice(index, 1);
                currentShots.forEach((shot, idx) => {
                    shot.number = String(idx + 1).padStart(2, '0');
                });
                renderStoryboard();
            }
        }

        // ä¸Šä¼ å‚è€ƒå›¾
        function handleReferenceDrop(e, index) {
            e.preventDefault();
            e.stopPropagation();
            const files = e.dataTransfer.files;
            if (files.length > 0) loadReferenceImage(files[0], index);
        }

        function loadReferenceImage(file, index) {
            if (!file.type.startsWith('image/')) { alert('è¯·ä¸Šä¼ å›¾ç‰‡'); return; }
            const reader = new FileReader();
            reader.onload = (e) => {
                currentShots[index].referenceImage = e.target.result;
                renderStoryboard();
            };
            reader.readAsDataURL(file);
        }

        // æ‰¹é‡ç”Ÿæˆ
        async function generateStoryboard() {
            const apiKey = document.getElementById('apiKey').value.trim();
            if (!apiKey) { alert('è¯·è¾“å…¥ API Key'); return; }
            if (currentShots.length === 0) { alert('è¯·å…ˆè§£æå‰§æœ¬'); return; }

            isGenerating = true;
            const btn = document.getElementById('generateBtn');
            btn.disabled = true;
            btn.textContent = 'ç”Ÿæˆä¸­...';

            const promises = currentShots.map((_, index) => generateShot(index, apiKey));
            await Promise.all(promises);

            isGenerating = false;
            btn.disabled = false;
            btn.textContent = 'é‡æ–°ç”Ÿæˆ';
        }

        async function regenerateShot(index) {
            const apiKey = document.getElementById('apiKey').value.trim();
            if (!apiKey) { alert('è¯·è¾“å…¥ API Key'); return; }

            currentShots[index].camera = document.getElementById(`camera-${index}`).value;
            currentShots[index].content = document.getElementById(`content-${index}`).value;
            currentShots[index].audio = document.getElementById(`audio-${index}`).value;
            currentShots[index].status = 'generating';
            currentShots[index].generatedImage = null;

            renderStoryboard();
            await generateShot(index, apiKey);
        }

        async function generateShot(index, apiKey) {
            const shot = currentShots[index];
            shot.status = 'generating';
            renderStoryboard();

            const baseUrl = document.getElementById('apiEndpoint').value;
            const size = document.getElementById('imageQuality').value;
            const scene = document.getElementById('sceneDesc').value || '';
            const stylePrompt = buildStylePrompt();

            // æ„å»ºæç¤ºè¯ - åŒ…å«ç”»é¢é£æ ¼
            const promptText = `${shot.camera}ã€‚${shot.content}ã€‚åœºæ™¯ï¼š${scene}ã€‚${stylePrompt}ã€‚å£°éŸ³æ°›å›´ï¼š${shot.audio}`;

            try {
                let body;

                if (shot.referenceImage) {
                    // å›¾ç”Ÿå›¾
                    body = {
                        model: 'gemini-3-pro-image-preview',
                        prompt: promptText,
                        image: shot.referenceImage,
                        size: size,
                        response_format: 'b64_json'
                    };
                } else {
                    // æ–‡ç”Ÿå›¾
                    body = {
                        model: 'gemini-3-pro-image-preview',
                        prompt: promptText,
                        size: size,
                        response_format: 'b64_json'
                    };
                }

                const response = await fetch(`${baseUrl}/images/generations`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(body)
                });

                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.error?.message || `HTTP ${response.status}`);
                }

                const data = await response.json();

                if (data.data && data.data[0]) {
                    if (data.data[0].b64_json) {
                        shot.generatedImage = `data:image/png;base64,${data.data[0].b64_json}`;
                    } else if (data.data[0].url) {
                        shot.generatedImage = data.data[0].url;
                    }
                    shot.status = 'completed';
                } else {
                    throw new Error('æ— å›¾ç‰‡æ•°æ®');
                }

            } catch (error) {
                console.error('ç”Ÿæˆé”™è¯¯:', error);
                shot.status = 'error';
                shot.error = error.message;
            }

            renderStoryboard();
        }

        function openImageModal(src) {
            const modal = document.getElementById('imageModal');
            document.getElementById('modalImage').src = src;
            modal.classList.add('active');
        }

        function closeImageModal(e) {
            if (e.target.id === 'imageModal') {
                document.getElementById('imageModal').classList.remove('active');
            }
        }

        function renderStoryboard() {
            const container = document.getElementById('storyboardContainer');
            const title = document.getElementById('projectTitle').value || 'æœªå‘½å';
            const aspectRatio = document.getElementById('aspectRatio').value;

            // æ˜¾ç¤ºå½“å‰é£æ ¼æ ‡ç­¾
            const era = document.getElementById('eraBackground').value;
            const atmosphere = document.getElementById('atmosphere').value;
            const color = document.getElementById('colorTone').value;
            const lighting = document.getElementById('lightingQuality').value;

            let styleTags = '';
            if (era) styleTags += `<span class="style-tag">${era}</span>`;
            if (atmosphere) styleTags += `<span class="style-tag">${atmosphere}</span>`;
            if (color) styleTags += `<span class="style-tag">${color}</span>`;
            if (lighting) styleTags += `<span class="style-tag">${lighting}</span>`;

            if (currentShots.length === 0) {
                container.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-full text-neutral-600 min-h-[60vh]">
                        <div class="text-4xl mb-3 opacity-20">ğŸ¬</div>
                        <p class="text-sm">æš‚æ— åˆ†é•œ</p>
                    </div>
                `;
                return;
            }

            const ratioMap = {
                '16:9': '56.25%', '4:3': '75%', '2.39:1': '41.84%', 
                '9:16': '177.78%', '1:1': '100%'
            };
            const paddingBottom = ratioMap[aspectRatio] || '56.25%';

            let html = `
                <div class="mb-4 pb-3 border-b border-neutral-800">
                    <div class="flex justify-between items-end mb-2">
                        <div>
                            <h2 class="text-xl font-black tracking-tight">${title}</h2>
                            <p class="text-neutral-500 text-xs mono">${document.getElementById('sceneDesc').value || ''}</p>
                        </div>
                        <div class="text-right text-[10px] text-neutral-600 mono">
                            <div>${new Date().toLocaleDateString('zh-CN')}</div>
                            <div>${currentShots.length} SHOTS | ${aspectRatio}</div>
                        </div>
                    </div>
                    ${styleTags ? `<div class="mt-2">${styleTags}</div>` : ''}
                </div>
                <div class="masonry-grid">
            `;

            currentShots.forEach((shot, index) => {
                const hasRef = shot.referenceImage ? 'has-image' : '';
                html += `
                    <div class="shot-card mb-3">
                        <button class="delete-btn" onclick="deleteShot(${index})" title="åˆ é™¤é•œå¤´">Ã—</button>

                        <div class="reference-upload ${hasRef}"
                             ondragover="event.preventDefault()" 
                             ondrop="handleReferenceDrop(event, ${index})"
                             onclick="document.getElementById('refInput-${index}').click()">
                            ${shot.referenceImage ? `
                                <img src="${shot.referenceImage}" class="reference-thumb" 
                                     onclick="event.stopPropagation(); openImageModal('${shot.referenceImage}')">
                            ` : `
                                <div class="text-[10px] text-neutral-500 py-1">ğŸ–¼ï¸ å‚è€ƒå›¾</div>
                            `}
                            <input type="file" id="refInput-${index}" class="hidden" accept="image/*" 
                                   onchange="loadReferenceImage(this.files[0], ${index})">
                        </div>

                        <div style="position: relative; padding-bottom: ${paddingBottom}; background: #0a0a0a; overflow: hidden; cursor: ${shot.generatedImage ? 'zoom-in' : 'default'};"
                             onclick="${shot.generatedImage ? `openImageModal('${shot.generatedImage}')` : ''}">
                            ${shot.generatedImage ? `
                                <img src="${shot.generatedImage}" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover;">
                            ` : `
                                <div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center;">
                                    ${shot.status === 'generating' ? 
                                        '<div class="animate-spin w-5 h-5 border-2 border-white border-t-transparent rounded-full"></div>' :
                                        shot.status === 'error' ?
                                        '<span class="text-red-500 text-[10px]">ERROR</span>' :
                                        '<span class="text-neutral-600 text-lg">ğŸ¬</span>'
                                    }
                                </div>
                            `}
                            ${shot.status === 'generating' ? '<div class="absolute inset-0 loading-scan"></div>' : ''}
                        </div>

                        <div class="p-2 bg-black">
                            <div class="flex justify-between items-center mb-1">
                                <span class="text-[10px] font-bold mono text-neutral-400">SHOT ${shot.number}</span>
                                <button onclick="regenerateShot(${index})" class="btn-secondary" ${shot.status === 'generating' ? 'disabled' : ''}>
                                    â†» é‡ç”Ÿæˆ
                                </button>
                            </div>

                            <div class="edit-section">
                                <div class="edit-section-header">è¿é•œ CAMERA</div>
                                <textarea id="camera-${index}" class="edit-textarea" rows="2">${shot.camera}</textarea>
                            </div>

                            <div class="edit-section">
                                <div class="edit-section-header">ç”»é¢ CONTENT</div>
                                <textarea id="content-${index}" class="edit-textarea" rows="2">${shot.content}</textarea>
                            </div>

                            <div class="edit-section">
                                <div class="edit-section-header">éŸ³æ•ˆ AUDIO</div>
                                <textarea id="audio-${index}" class="edit-textarea" rows="2">${shot.audio}</textarea>
                            </div>
                        </div>
                    </div>
                `;
            });

            html += '</div>';
            container.innerHTML = html;
        }

        // åˆå§‹åŒ–
        window.addEventListener('load', () => {
            document.getElementById('apiKey').value = localStorage.getItem('apiyi_key') || '';
        });
        document.getElementById('apiKey').addEventListener('change', (e) => {
            localStorage.setItem('apiyi_key', e.target.value);
        });
    </script>
</body>
</html>
