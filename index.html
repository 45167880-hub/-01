<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI åˆ†é•œç”Ÿæˆå™¨ - Professional Storyboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;700;900&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        * {
            scrollbar-width: thin;
            scrollbar-color: #333 #0a0a0a;
        }
        body {
            font-family: 'Noto Serif SC', serif;
            background-color: #050505;
            color: #e5e5e5;
            overflow: hidden;
        }
        .mono { font-family: 'JetBrains Mono', monospace; }
        .storyboard-grid {
            background-image: 
                linear-gradient(rgba(255,255,255,0.02) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255,255,255,0.02) 1px, transparent 1px);
            background-size: 20px 20px;
        }
        
        /* å·¦ä¾§æ»šåŠ¨é¢æ¿ */
        .left-panel {
            height: 100vh;
            overflow-y: auto;
            overflow-x: hidden;
            padding-bottom: 100px;
        }
        .left-panel::-webkit-scrollbar {
            width: 6px;
        }
        .left-panel::-webkit-scrollbar-track {
            background: #0a0a0a;
        }
        .left-panel::-webkit-scrollbar-thumb {
            background: #333;
            border-radius: 3px;
        }
        
        /* åˆ†é•œå¡ç‰‡ */
        .shot-card {
            transition: all 0.3s ease;
            border: 1px solid #333;
            background: linear-gradient(135deg, #0a0a0a 0%, #111 100%);
        }
        .shot-card:hover {
            border-color: #555;
        }
        
        /* å›¾ç‰‡æ”¾å¤§é®ç½© */
        .image-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0,0,0,0.95);
            z-index: 200;
            justify-content: center;
            align-items: center;
            cursor: zoom-out;
        }
        .image-modal.active {
            display: flex;
        }
        .image-modal img {
            max-width: 90vw;
            max-height: 90vh;
            object-fit: contain;
            cursor: default;
        }
        .image-modal .close-hint {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            color: #666;
            font-size: 12px;
        }
        
        /* ç¼–è¾‘åŒºåŸŸæ ·å¼ */
        .edit-section {
            background: #0a0a0a;
            border: 1px solid #333;
            margin-bottom: 12px;
        }
        .edit-section-header {
            background: #1a1a1a;
            padding: 8px 12px;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #888;
            border-bottom: 1px solid #333;
        }
        .edit-textarea {
            width: 100%;
            background: transparent;
            border: none;
            color: #e5e5e5;
            padding: 12px;
            font-size: 13px;
            line-height: 1.6;
            resize: vertical;
            min-height: 60px;
            font-family: inherit;
        }
        .edit-textarea:focus {
            outline: none;
            background: rgba(255,255,255,0.02);
        }
        
        /* è§†è§‰é£æ ¼é¢æ¿ */
        .style-panel {
            background: linear-gradient(135deg, #111 0%, #0a0a0a 100%);
            border: 1px solid #333;
        }
        
        /* æ‹–æ‹½åŒºåŸŸ */
        .drop-zone {
            border: 2px dashed #444;
            background: rgba(255,255,255,0.02);
            transition: all 0.3s;
        }
        .drop-zone.drag-over {
            border-color: #fff;
            background: rgba(255,255,255,0.05);
        }
        
        /* åŠ è½½åŠ¨ç”» */
        .loading-scan {
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            animation: scan 2s infinite;
        }
        @keyframes scan {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        /* é¢—ç²’å™ªç‚¹ */
        .grain {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            z-index: 50;
            opacity: 0.02;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
        }
        
        /* æŒ‰é’®æ ·å¼ */
        .btn-primary {
            background: #fff;
            color: #000;
            border: none;
            padding: 10px 20px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-primary:hover {
            background: #ccc;
        }
        .btn-secondary {
            background: transparent;
            border: 1px solid #555;
            color: #aaa;
            padding: 8px 16px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-secondary:hover {
            border-color: #fff;
            color: #fff;
        }
        
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #fff;
        }
    </style>
</head>
<body class="storyboard-grid">
    <div class="grain"></div>
    
    <!-- å›¾ç‰‡æ”¾å¤§æ¨¡æ€æ¡† -->
    <div class="image-modal" id="imageModal" onclick="closeImageModal(event)">
        <img id="modalImage" src="" alt="æ”¾å¤§å›¾ç‰‡">
        <div class="close-hint">ç‚¹å‡»ä»»æ„å¤„å…³é—­</div>
    </div>

    <div class="flex h-screen">
        <!-- å·¦ä¾§å·¥ä½œæ ï¼ˆå¯æ»šåŠ¨ï¼‰ -->
        <div class="left-panel w-1/3 border-r border-neutral-800 bg-black/80 backdrop-blur">
            <div class="p-6 space-y-6">
                
                <!-- Header -->
                <div class="flex items-center gap-3 pb-4 border-b border-neutral-800">
                    <div class="w-10 h-10 bg-white text-black flex items-center justify-center font-black text-xl mono">S</div>
                    <div>
                        <h1 class="text-lg font-black tracking-tight">STORYBOARD<span class="text-neutral-500">_GEN</span></h1>
                        <p class="text-xs text-neutral-500 mono">PROFESSIONAL</p>
                    </div>
                </div>

                <!-- API é…ç½® -->
                <div class="space-y-3">
                    <h2 class="text-xs font-bold text-neutral-400 uppercase tracking-widest">API é…ç½®</h2>
                    <input type="password" id="apiKey" placeholder="è¾“å…¥ APIæ˜“ Key..." 
                        class="w-full bg-neutral-900 border border-neutral-700 p-3 text-white placeholder-neutral-600 text-sm mono">
                    
                    <select id="apiEndpoint" class="w-full bg-neutral-900 border border-neutral-700 p-3 text-white text-sm">
                        <option value="https://vip.apiyi.com/v1" selected>vip.apiyi.com (æ¨è)</option>
                        <option value="https://api.apiyi.com/v1">api.apiyi.com</option>
                    </select>
                </div>

                <!-- æ‹–æ‹½ä¸Šä¼ åŒºåŸŸ -->
                <div class="drop-zone p-6 text-center rounded" id="dropZone">
                    <div class="text-3xl mb-2">ğŸ“„</div>
                    <p class="text-sm text-neutral-400 mb-1">æ‹–æ‹½ Word æ–‡æ¡£åˆ°æ­¤å¤„</p>
                    <p class="text-xs text-neutral-600">è‡ªåŠ¨è§£æå‰§æœ¬å’Œè§†è§‰é£æ ¼</p>
                    <input type="file" id="fileInput" accept=".doc,.docx,.txt" class="hidden">
                </div>

                <!-- å½±ç‰‡è§†è§‰é£æ ¼æè¿° -->
                <div class="style-panel p-4 space-y-3">
                    <h2 class="text-xs font-bold text-neutral-400 uppercase tracking-widest flex justify-between">
                        <span>å½±ç‰‡è§†è§‰é£æ ¼</span>
                        <span class="text-neutral-600 text-[10px]">VISUAL STYLE</span>
                    </h2>
                    
                    <div>
                        <label class="text-[10px] text-neutral-500 uppercase block mb-1">æ°›å›´åŸºè°ƒ ATMOSPHERE</label>
                        <textarea id="atmosphere" placeholder="ä¾‹å¦‚ï¼šå‹æŠ‘ã€ç´§å¼ ã€ç¥ç§˜..." 
                            class="edit-textarea min-h-[50px] text-xs bg-neutral-900 border border-neutral-800"></textarea>
                    </div>
                    
                    <div>
                        <label class="text-[10px] text-neutral-500 uppercase block mb-1">è‰²å½©å€¾å‘ COLOR</label>
                        <textarea id="colorTone" placeholder="ä¾‹å¦‚ï¼šå†·è‰²è°ƒã€é«˜å¯¹æ¯”é»‘ç™½..." 
                            class="edit-textarea min-h-[50px] text-xs bg-neutral-900 border border-neutral-800"></textarea>
                    </div>
                    
                    <div>
                        <label class="text-[10px] text-neutral-500 uppercase block mb-1">å…‰å½±è´¨æ„Ÿ LIGHTING</label>
                        <textarea id="lighting" placeholder="ä¾‹å¦‚ï¼šç¡¬å…‰ã€å‰ªå½±ã€éœ“è™¹åå°„..." 
                            class="edit-textarea min-h-[50px] text-xs bg-neutral-900 border border-neutral-800"></textarea>
                    </div>
                </div>

                <!-- é¡¹ç›®ä¿¡æ¯ -->
                <div class="space-y-3">
                    <h2 class="text-xs font-bold text-neutral-400 uppercase tracking-widest">é¡¹ç›®ä¿¡æ¯</h2>
                    <input type="text" id="projectTitle" placeholder="ç‰‡å..." 
                        class="w-full bg-neutral-900 border border-neutral-700 p-3 text-white placeholder-neutral-600 text-sm">
                    <input type="text" id="sceneDesc" placeholder="åœºæ™¯æè¿°ï¼ˆä¾‹å¦‚ï¼šå†…æ™¯ å’–å•¡é¦† å¤œï¼‰..." 
                        class="w-full bg-neutral-900 border border-neutral-700 p-3 text-white placeholder-neutral-600 text-sm">
                </div>

                <!-- ç”ŸæˆæŒ‰é’® -->
                <button onclick="generateStoryboard()" id="generateBtn"
                    class="btn-primary w-full py-3 text-sm">
                    ç”Ÿæˆåˆ†é•œç¨¿
                </button>

                <!-- ä½¿ç”¨è¯´æ˜ -->
                <div class="text-xs text-neutral-600 space-y-1 pt-4 border-t border-neutral-800">
                    <p>â€¢ æ‹–æ‹½ Word æ–‡æ¡£è‡ªåŠ¨è§£æå‰§æœ¬</p>
                    <p>â€¢ ç‚¹å‡»ç”Ÿæˆçš„å›¾ç‰‡å•ç‹¬æ”¾å¤§æŸ¥çœ‹</p>
                    <p>â€¢ ç›´æ¥åœ¨ç¼–è¾‘æ¡†ä¿®æ”¹æè¿°å¹¶é‡æ–°ç”Ÿæˆ</p>
                </div>
            </div>
        </div>

        <!-- å³ä¾§åˆ†é•œé¢„è§ˆåŒº -->
        <div class="w-2/3 h-screen overflow-y-auto p-6" id="rightPanel">
            <div id="storyboardContainer" class="space-y-6">
                <!-- Empty State -->
                <div class="flex flex-col items-center justify-center h-full text-neutral-600 min-h-[60vh]">
                    <div class="text-6xl mb-4 opacity-20">ğŸ¬</div>
                    <p class="text-lg mb-2">ç­‰å¾…ç”Ÿæˆ</p>
                    <p class="text-sm text-center max-w-md">æ‹–æ‹½ Word æ–‡æ¡£æˆ–æ‰‹åŠ¨è¾“å…¥å‰§æœ¬å†…å®¹<br>AI å°†è‡ªåŠ¨ç”Ÿæˆä¸“ä¸šåˆ†é•œç¨¿</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentShots = [];
        let isGenerating = false;
        let visualStyle = {
            atmosphere: '',
            colorTone: '',
            lighting: ''
        };

        // ç»Ÿä¸€çš„é£æ ¼æç¤ºè¯
        const BASE_STYLE = `Rough black-and-white storyboard sketches, heavy and bold black outlines, strong light and shadow contrast, high-contrast shadows, loose gesture lines, cinematic composition, film aesthetics, Photoshop brush texture, quick sketch style, dramatic light and shadow separation`;

        // æ–‡ä»¶æ‹–æ‹½å¤„ç†
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');

        dropZone.addEventListener('click', () => fileInput.click());
        
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('drag-over');
        });
        
        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('drag-over');
        });
        
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('drag-over');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        });

        function handleFile(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const content = e.target.result;
                parseScriptFromText(content);
            };
            reader.readAsText(file);
        }

        function parseScriptFromText(text) {
            // å°è¯•è§£æè§†è§‰é£æ ¼æè¿°
            const stylePatterns = {
                atmosphere: /æ°›å›´åŸºè°ƒ[ï¼š:]\s*([^\n]+)/i,
                colorTone: /è‰²å½©å€¾å‘[ï¼š:]\s*([^\n]+)/i,
                lighting: /å…‰å½±è´¨æ„Ÿ[ï¼š:]\s*([^\n]+)/i
            };

            for (let [key, pattern] of Object.entries(stylePatterns)) {
                const match = text.match(pattern);
                if (match) {
                    document.getElementById(key).value = match[1].trim();
                    visualStyle[key] = match[1].trim();
                }
            }

            // è§£æé•œå¤´
            const shots = [];
            const lines = text.split('\n').filter(line => line.trim());
            let currentShot = null;

            lines.forEach(line => {
                // åŒ¹é…é•œå¤´æ ‡è®°
                const shotMatch = line.match(/é•œå¤´\s*(\d+)[\s:ï¼š]*/i);
                if (shotMatch) {
                    if (currentShot) shots.push(currentShot);
                    
                    currentShot = {
                        number: shotMatch[1],
                        camera: '',
                        content: '',
                        audio: '',
                        dialogues: [],
                        imageUrl: null,
                        status: 'pending'
                    };
                } else if (currentShot) {
                    // è§£æè¿é•œæè¿°
                    const cameraMatch = line.match(/è¿é•œ[ï¼š:]\s*([^\n]+)/i);
                    if (cameraMatch) {
                        currentShot.camera = cameraMatch[1].trim();
                        return;
                    }
                    
                    // è§£æç”»é¢å†…å®¹
                    const contentMatch = line.match(/ç”»é¢[ï¼š:]\s*([^\n]+)/i);
                    if (contentMatch) {
                        currentShot.content = contentMatch[1].trim();
                        return;
                    }
                    
                    // è§£æéŸ³æ•ˆé…éŸ³
                    const audioMatch = line.match(/éŸ³æ•ˆ[ï¼š:]\s*([^\n]+)/i);
                    if (audioMatch) {
                        currentShot.audio = audioMatch[1].trim();
                        return;
                    }
                    
                    // è§£æå¯¹ç™½
                    const dialogueMatch = line.match(/^([^ï¼š:]+)[ï¼š:](.+)$/);
                    if (dialogueMatch && !line.includes('è¿é•œ') && !line.includes('ç”»é¢') && !line.includes('éŸ³æ•ˆ')) {
                        currentShot.dialogues.push({
                            character: dialogueMatch[1].trim(),
                            line: dialogueMatch[2].trim()
                        });
                    }
                }
            });

            if (currentShot) shots.push(currentShot);
            
            if (shots.length > 0) {
                currentShots = shots;
                renderStoryboard();
                alert(`æˆåŠŸè§£æ ${shots.length} ä¸ªé•œå¤´`);
            } else {
                // å¦‚æœæ²¡æœ‰åŒ¹é…åˆ°æ ‡å‡†æ ¼å¼ï¼Œå°è¯•ç®€å•è§£æ
                parseSimpleScript(text);
            }
        }

        function parseSimpleScript(text) {
            const shots = [];
            const lines = text.split('\n').filter(line => line.trim());
            let currentShot = null;
            let shotNum = 1;

            lines.forEach(line => {
                if (line.match(/^(é•œå¤´|Shot|#)\s*\d+/i) || line.match(/^\d+[\.ã€]/)) {
                    if (currentShot) shots.push(currentShot);
                    
                    currentShot = {
                        number: String(shotNum++).padStart(2, '0'),
                        camera: '',
                        content: line.replace(/^[\d\sé•œå¤´Shot#\.ã€]+/i, '').trim(),
                        audio: '',
                        dialogues: [],
                        imageUrl: null,
                        status: 'pending'
                    };
                } else if (currentShot) {
                    const dialogueMatch = line.match(/^([^ï¼š:]+)[ï¼š:](.+)$/);
                    if (dialogueMatch) {
                        currentShot.dialogues.push({
                            character: dialogueMatch[1].trim(),
                            line: dialogueMatch[2].trim()
                        });
                    } else {
                        currentShot.content += ' ' + line.trim();
                    }
                }
            });

            if (currentShot) shots.push(currentShot);
            
            if (shots.length > 0) {
                currentShots = shots;
                renderStoryboard();
                alert(`æˆåŠŸè§£æ ${shots.length} ä¸ªé•œå¤´ï¼ˆç®€å•æ¨¡å¼ï¼‰`);
            }
        }

        function getVisualStylePrompt() {
            const atmosphere = document.getElementById('atmosphere').value || visualStyle.atmosphere || '';
            const colorTone = document.getElementById('colorTone').value || visualStyle.colorTone || '';
            const lighting = document.getElementById('lighting').value || visualStyle.lighting || '';
            
            let stylePrompt = BASE_STYLE;
            
            if (atmosphere) stylePrompt += `, ${atmosphere} atmosphere`;
            if (colorTone) stylePrompt += `, ${colorTone} color palette`;
            if (lighting) stylePrompt += `, ${lighting} lighting`;
            
            return stylePrompt;
        }

        async function generateStoryboard() {
            const apiKey = document.getElementById('apiKey').value.trim();
            if (!apiKey) {
                alert('è¯·è¾“å…¥ API Key');
                return;
            }

            if (currentShots.length === 0) {
                alert('è¯·å…ˆæ‹–æ‹½ Word æ–‡æ¡£æˆ–æ‰‹åŠ¨æ·»åŠ å‰§æœ¬');
                return;
            }

            isGenerating = true;
            document.getElementById('generateBtn').disabled = true;
            document.getElementById('generateBtn').textContent = 'ç”Ÿæˆä¸­...';

            const scene = document.getElementById('sceneDesc').value || '';
            const stylePrompt = getVisualStylePrompt();

            for (let i = 0; i < currentShots.length; i++) {
                await generateImageForShot(i, apiKey, scene, stylePrompt);
                renderStoryboard();
            }

            isGenerating = false;
            document.getElementById('generateBtn').disabled = false;
            document.getElementById('generateBtn').textContent = 'ç”Ÿæˆåˆ†é•œç¨¿';
        }

        async function regenerateShot(index) {
            const apiKey = document.getElementById('apiKey').value.trim();
            if (!apiKey) {
                alert('è¯·è¾“å…¥ API Key');
                return;
            }

            // è·å–ç¼–è¾‘åçš„å†…å®¹
            currentShots[index].camera = document.getElementById(`camera-${index}`).value;
            currentShots[index].content = document.getElementById(`content-${index}`).value;
            currentShots[index].audio = document.getElementById(`audio-${index}`).value;

            const scene = document.getElementById('sceneDesc').value || '';
            const stylePrompt = getVisualStylePrompt();

            currentShots[index].status = 'generating';
            currentShots[index].imageUrl = null;
            renderStoryboard();

            await generateImageForShot(index, apiKey, scene, stylePrompt);
            renderStoryboard();
        }

        async function generateImageForShot(index, apiKey, sceneContext, stylePrompt) {
            const shot = currentShots[index];
            shot.status = 'generating';

            const baseUrl = document.getElementById('apiEndpoint').value;
            
            // æ„å»ºæç¤ºè¯
            const content = shot.content || '';
            const camera = shot.camera || '';
            const prompt = `${camera} camera shot: ${content}. Scene: ${sceneContext}. ${stylePrompt}`;

            for (let retry = 0; retry < 3; retry++) {
                try {
                    console.log(`Generating shot ${shot.number}:`, prompt);

                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 120000);

                    const response = await fetch(`${baseUrl}/images/generations`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${apiKey}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            model: 'gemini-3-pro-image-preview',
                            prompt: prompt,
                            n: 1,
                            size: '1024x1024',
                            quality: 'standard',
                            response_format: 'url'
                        }),
                        signal: controller.signal
                    });

                    clearTimeout(timeoutId);

                    if (!response.ok) {
                        throw new Error(`API Error ${response.status}`);
                    }

                    const data = await response.json();

                    if (data.data && data.data[0] && data.data[0].url) {
                        shot.imageUrl = data.data[0].url;
                        shot.status = 'completed';
                        return;
                    } else if (data.data && data.data[0] && data.data[0].b64_json) {
                        shot.imageUrl = `data:image/jpeg;base64,${data.data[0].b64_json}`;
                        shot.status = 'completed';
                        return;
                    } else {
                        throw new Error('No image data');
                    }
                } catch (error) {
                    console.error(`Error (attempt ${retry + 1}):`, error);
                    if (retry === 2) {
                        shot.status = 'error';
                        shot.error = error.message;
                    } else {
                        await new Promise(r => setTimeout(r, 1000));
                    }
                }
            }
        }

        function openImageModal(src) {
            const modal = document.getElementById('imageModal');
            const img = document.getElementById('modalImage');
            img.src = src;
            modal.classList.add('active');
        }

        function closeImageModal(e) {
            if (e.target.id === 'imageModal') {
                document.getElementById('imageModal').classList.remove('active');
            }
        }

        function renderStoryboard() {
            const container = document.getElementById('storyboardContainer');
            const title = document.getElementById('projectTitle').value || 'æœªå‘½åé¡¹ç›®';
            const timestamp = new Date().toLocaleDateString('zh-CN');

            if (currentShots.length === 0) return;

            let html = `
                <div class="mb-6 pb-4 border-b border-neutral-800 flex justify-between items-end">
                    <div>
                        <h2 class="text-2xl font-black tracking-tight">${title}</h2>
                        <p class="text-neutral-500 text-sm mono mt-1">${document.getElementById('sceneDesc').value || ''}</p>
                    </div>
                    <div class="text-right text-xs text-neutral-600 mono">
                        <div>${timestamp}</div>
                        <div>${currentShots.length} SHOTS</div>
                    </div>
                </div>
                <div class="grid grid-cols-2 lg:grid-cols-3 gap-4">
            `;

            currentShots.forEach((shot, index) => {
                html += `
                    <div class="shot-card overflow-hidden">
                        <!-- å›¾ç‰‡åŒºåŸŸï¼ˆå¯ç‚¹å‡»æ”¾å¤§ï¼‰ -->
                        <div class="aspect-[4/3] bg-neutral-900 relative overflow-hidden border-b border-neutral-800 cursor-zoom-in"
                             onclick="if('${shot.imageUrl}') openImageModal('${shot.imageUrl}')">
                            ${shot.imageUrl ? `
                                <img src="${shot.imageUrl}" class="w-full h-full object-cover generated-image hover:opacity-90 transition-opacity">
                            ` : `
                                <div class="w-full h-full flex items-center justify-center">
                                    ${shot.status === 'generating' ? 
                                        '<div class="animate-spin w-8 h-8 border-2 border-white border-t-transparent rounded-full"></div>' :
                                        shot.status === 'error' ?
                                        '<span class="text-red-500 text-xs">ERROR</span>' :
                                        '<span class="text-neutral-600 text-2xl">ğŸ¬</span>'
                                    }
                                </div>
                            `}
                            ${shot.status === 'generating' ? '<div class="absolute inset-0 loading-scan"></div>' : ''}
                        </div>

                        <!-- ç¼–è¾‘åŒºåŸŸ -->
                        <div class="p-3 space-y-2 bg-black">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-xs font-bold mono text-neutral-400">SHOT ${shot.number}</span>
                                <button onclick="regenerateShot(${index})" class="btn-secondary text-xs py-1 px-3">
                                    â†» é‡æ–°ç”Ÿæˆ
                                </button>
                            </div>

                            <!-- è¿é•œæè¿° -->
                            <div class="edit-section">
                                <div class="edit-section-header">è¿é•œæè¿° CAMERA</div>
                                <textarea id="camera-${index}" class="edit-textarea" rows="2" 
                                    placeholder="è¿é•œæ–¹å¼...">${shot.camera}</textarea>
                            </div>

                            <!-- ç”»é¢å†…å®¹ -->
                            <div class="edit-section">
                                <div class="edit-section-header">ç”»é¢å†…å®¹ CONTENT</div>
                                <textarea id="content-${index}" class="edit-textarea" rows="3" 
                                    placeholder="ç”»é¢æè¿°...">${shot.content}</textarea>
                            </div>

                            <!-- éŸ³æ•ˆé…éŸ³ -->
                            <div class="edit-section">
                                <div class="edit-section-header">éŸ³æ•ˆé…éŸ³ AUDIO</div>
                                <textarea id="audio-${index}" class="edit-textarea" rows="2" 
                                    placeholder="éŸ³æ•ˆã€é…éŸ³...">${shot.audio}</textarea>
                            </div>

                            <!-- å¯¹ç™½ -->
                            ${shot.dialogues.length > 0 ? `
                                <div class="mt-2 pt-2 border-t border-neutral-800">
                                    <div class="text-[10px] text-neutral-500 uppercase mb-1">å¯¹ç™½ DIALOGUE</div>
                                    ${shot.dialogues.map(d => `
                                        <div class="text-xs text-neutral-300 mb-1">
                                            <span class="text-neutral-500">${d.character}:</span> ${d.line}
                                        </div>
                                    `).join('')}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            });

            html += '</div>';
            container.innerHTML = html;
        }

        // åˆå§‹åŒ–
        window.addEventListener('load', () => {
            document.getElementById('apiKey').value = localStorage.getItem('sb_api_key') || '';
        });

        document.getElementById('apiKey').addEventListener('change', (e) => {
            localStorage.setItem('sb_api_key', e.target.value);
        });
    </script>
</body>
</html>
