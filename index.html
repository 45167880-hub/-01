<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nano Banana Pro - AI åˆ†é•œç”Ÿæˆå™¨</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;700;900&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Serif SC', serif;
            background-color: #050505;
            color: #e5e5e5;
        }
        .mono { font-family: 'JetBrains Mono', monospace; }
        .storyboard-grid {
            background-image: 
                linear-gradient(rgba(255,255,255,0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255,255,255,0.03) 1px, transparent 1px);
            background-size: 20px 20px;
        }
        .shot-card {
            transition: all 0.3s ease;
            border: 1px solid #333;
            background: linear-gradient(135deg, #0a0a0a 0%, #111 100%);
        }
        .shot-card:hover {
            border-color: #555;
            transform: translateY(-2px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.8);
        }
        .generated-image {
            image-rendering: high-quality;
            filter: contrast(1.1) brightness(0.95);
        }
        .loading-scan {
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            animation: scan 2s infinite;
        }
        @keyframes scan {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        .grain {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            z-index: 50;
            opacity: 0.02;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
        }
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #fff;
            box-shadow: 0 0 0 2px rgba(255,255,255,0.1);
        }
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #0a0a0a; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
    </style>
</head>
<body class="min-h-screen storyboard-grid">
    <div class="grain"></div>
    
    <!-- Header -->
    <header class="border-b border-neutral-800 bg-black/90 backdrop-blur-md sticky top-0 z-40">
        <div class="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-white text-black flex items-center justify-center font-black text-xl mono border-2 border-white">N</div>
                <div>
                    <h1 class="text-xl font-black tracking-tight">NANO BANANA<span class="text-neutral-500">_PRO</span></h1>
                    <p class="text-xs text-neutral-500 mono">AI STORYBOARD GENERATOR</p>
                </div>
            </div>
            <div class="flex items-center gap-4">
                <div class="text-right hidden sm:block">
                    <div class="text-xs text-neutral-500">API STATUS</div>
                    <div class="text-xs text-green-500 mono flex items-center gap-1 justify-end">
                        <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
                        READY
                    </div>
                </div>
                <button onclick="exportStoryboard()" class="px-4 py-2 bg-white text-black font-bold hover:bg-neutral-200 transition-all active:scale-95 text-sm border border-white">
                    å¯¼å‡ºåˆ†é•œ
                </button>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-6 py-8 flex flex-col lg:flex-row gap-8">
        <!-- Control Panel -->
        <div class="lg:w-1/3 space-y-6">
            
            <!-- API Configuration -->
            <div class="border border-neutral-800 bg-neutral-900/50 p-6 space-y-4">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-sm font-bold text-neutral-400 uppercase tracking-widest">API é…ç½®</h2>
                    <span class="text-xs text-neutral-600 mono">APIæ˜“</span>
                </div>
                
                <div>
                    <label class="block text-xs text-neutral-500 mb-2 uppercase tracking-wider flex justify-between">
                        <span>API Key</span>
                        <span class="text-neutral-700">å¿…å¡«</span>
                    </label>
                    <input type="password" id="apiKey" placeholder="è¾“å…¥ APIæ˜“ çš„ Key..." 
                        class="w-full bg-black border border-neutral-700 p-3 text-white placeholder-neutral-600 focus:border-white transition-colors mono text-sm">
                    <p class="text-xs text-neutral-600 mt-1">æ‚¨çš„ Key ä»…å­˜å‚¨åœ¨æœ¬åœ°æµè§ˆå™¨ä¸­</p>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-xs text-neutral-500 mb-2 uppercase tracking-wider">åˆ†è¾¨ç‡</label>
                        <select id="resolution" class="w-full bg-black border border-neutral-700 p-3 text-white focus:border-white transition-colors text-sm">
                            <option value="1024x1024">1K (1024Â²)</option>
                            <option value="2048x2048" selected>2K (2048Â²)</option>
                            <option value="4096x4096">4K (4096Â²)</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs text-neutral-500 mb-2 uppercase tracking-wider">æ¯”ä¾‹</label>
                        <select id="aspectRatio" class="w-full bg-black border border-neutral-700 p-3 text-white focus:border-white transition-colors text-sm">
                            <option value="1:1">1:1 æ–¹å½¢</option>
                            <option value="16:9" selected>16:9 å®½å±</option>
                            <option value="9:16">9:16 ç«–å±</option>
                            <option value="3:2">3:2 ç…§ç‰‡</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Script Input -->
            <div class="border border-neutral-800 bg-neutral-900/50 p-6 space-y-4">
                <h2 class="text-sm font-bold text-neutral-400 uppercase tracking-widest mb-4">å‰§æœ¬è¾“å…¥</h2>
                
                <div>
                    <label class="block text-xs text-neutral-500 mb-2 uppercase tracking-wider">ç‰‡å</label>
                    <input type="text" id="projectTitle" placeholder="è¾“å…¥ç‰‡å..." 
                        class="w-full bg-black border border-neutral-700 p-3 text-white placeholder-neutral-600 focus:border-white transition-colors">
                </div>

                <div>
                    <label class="block text-xs text-neutral-500 mb-2 uppercase tracking-wider">åœºæ™¯æè¿°</label>
                    <input type="text" id="sceneDesc" placeholder="ä¾‹å¦‚ï¼šå†…æ™¯ å’–å•¡é¦† å¤œ" 
                        class="w-full bg-black border border-neutral-700 p-3 text-white placeholder-neutral-600 focus:border-white transition-colors">
                </div>

                <div>
                    <label class="block text-xs text-neutral-500 mb-2 uppercase tracking-wider flex justify-between">
                        <span>å‰§æœ¬å†…å®¹</span>
                        <button onclick="loadExample()" class="text-xs text-neutral-400 hover:text-white underline">åŠ è½½ç¤ºä¾‹</button>
                    </label>
                    <textarea id="scriptInput" rows="10" placeholder="åœ¨æ­¤è¾“å…¥å‰§æœ¬ï¼Œæ ¼å¼ï¼š
é•œå¤´1 ç‰¹å†™ å’–å•¡æ¯ä¸­çš„æ¶Ÿæ¼ª
æœåŠ¡å‘˜ï¼šæ‚¨çš„å’–å•¡å¥½äº†ã€‚

é•œå¤´2 ä¸­æ™¯ ç”·äººæŠ¬å¤´
ç”·äººï¼šè°¢è°¢ã€‚" 
                        class="w-full bg-black border border-neutral-700 p-3 text-white placeholder-neutral-600 focus:border-white transition-colors mono text-sm leading-relaxed resize-y"></textarea>
                </div>

                <button onclick="generateStoryboard()" id="generateBtn"
                    class="w-full py-3 bg-white text-black font-bold hover:bg-neutral-200 transition-all active:scale-95 flex items-center justify-center gap-2">
                    <span>ç”Ÿæˆåˆ†é•œç¨¿</span>
                    <span class="mono text-xs opacity-50">â†’</span>
                </button>
            </div>

            <!-- Tips -->
            <div class="border border-neutral-800 bg-neutral-900/30 p-4 text-xs text-neutral-500 space-y-2">
                <p class="font-bold text-neutral-400 flex items-center gap-2">
                    <span class="w-1 h-1 bg-white rounded-full"></span>
                    ä½¿ç”¨è¯´æ˜
                </p>
                <p>â€¢ ä½¿ç”¨"é•œå¤´X"æ ‡è®°è‡ªåŠ¨åˆ†å‰²åœºæ™¯</p>
                <p>â€¢ æ”¯æŒæ–‡ç”Ÿå›¾ï¼ˆè¾“å…¥æè¿°ï¼‰å’Œå›¾ç”Ÿå›¾ï¼ˆä¸Šä¼ å‚è€ƒå›¾ï¼‰</p>
                <p>â€¢ Nano Banana Pro æ“…é•¿ç”Ÿæˆæ–‡å­—å’Œå¤æ‚æ„å›¾</p>
                <p>â€¢ 4K ç”Ÿæˆæ—¶é—´è¾ƒé•¿ï¼ˆçº¦20-30ç§’ï¼‰</p>
            </div>
        </div>

        <!-- Preview Panel -->
        <div class="lg:w-2/3">
            <div id="storyboardContainer" class="space-y-6">
                <!-- Empty State -->
                <div class="border-2 border-dashed border-neutral-800 p-16 text-center text-neutral-600 bg-black/20">
                    <div class="text-5xl mb-4 opacity-30">ğŸ¬</div>
                    <p class="text-lg mb-2 font-bold">ç­‰å¾…ç”Ÿæˆ</p>
                    <p class="text-sm max-w-md mx-auto">åœ¨å·¦ä¾§é…ç½® API Key å¹¶è¾“å…¥å‰§æœ¬å†…å®¹ï¼ŒAI å°†è‡ªåŠ¨ä¸ºæ¯ä¸ªé•œå¤´ç”Ÿæˆé»‘ç™½åˆ†é•œå›¾</p>
                </div>
            </div>
        </div>
    </main>

    <script>
        let currentShots = [];
        let isGenerating = false;

        function loadExample() {
            document.getElementById('projectTitle').value = 'ã€Šé›¨å¤œè¿½è¸ªã€‹';
            document.getElementById('sceneDesc').value = 'å†…æ™¯ å¤å¤å’–å•¡é¦† é›¨å¤œ';
            document.getElementById('scriptInput').value = `é•œå¤´1 å…¨æ™¯ é›¨å¤œè¡—é“ï¼Œéœ“è™¹ç¯åœ¨æ¹¿æ¼‰æ¼‰çš„åœ°é¢ä¸Šåå°„ï¼Œä¸€è¾†é»‘è‰²è½¿è½¦ç¼“ç¼“é©¶è¿‡
é•œå¤´2 ç‰¹å†™ å’–å•¡é¦†é—¨æŠŠæ‰‹ï¼Œä¸€åªæˆ´ç€é»‘è‰²çš®æ‰‹å¥—çš„æ‰‹æ¡ä½å®ƒ
é•œå¤´3 ä¸­æ™¯ é—¨è¢«æ¨å¼€ï¼Œé£è¡£ç”·å­èµ°å…¥ï¼ŒæŠ–è½é›¨ä¼ä¸Šçš„æ°´ç 
ç”·äººï¼šä¸€æ¯ç¾å¼ï¼Œä¸åŠ ç³–ã€‚
é•œå¤´4 è¿‘æ™¯ æœåŠ¡å‘˜æŠ¬å¤´ï¼Œçœ¼ç¥è­¦æƒ•ï¼Œæ‰‹ä¼¸å‘æŸœå°ä¸‹çš„æŠ¥è­¦å™¨
æœåŠ¡å‘˜ï¼šè¿™ä¹ˆæ™šäº†ï¼Œå…ˆç”Ÿæ‰¾è°ï¼Ÿ
é•œå¤´5 ç‰¹å†™ ç”·äººä»æ€€ä¸­æå‡ºæ³›é»„çš„ç…§ç‰‡æ”¾åœ¨æŸœå°ä¸Š
ç”·äººï¼šæˆ‘åœ¨æ‰¾è¿™ä¸ªäººã€‚`;
        }

        function parseScript() {
            const input = document.getElementById('scriptInput').value;
            if (!input.trim()) return [];

            const lines = input.split('\n').filter(line => line.trim());
            const shots = [];
            let currentShot = null;

            lines.forEach(line => {
                const shotMatch = line.match(/é•œå¤´\s*(\d+)\s*([^\n]*)/i);
                
                if (shotMatch) {
                    if (currentShot) shots.push(currentShot);
                    
                    const shotNum = shotMatch[1];
                    const content = shotMatch[2].trim();
                    
                    const sizes = ['ç‰¹å†™', 'è¿‘æ™¯', 'ä¸­æ™¯', 'å…¨æ™¯', 'è¿œæ™¯'];
                    let size = 'ä¸­æ™¯';
                    sizes.forEach(s => {
                        if (content.includes(s)) size = s;
                    });

                    currentShot = {
                        number: shotNum,
                        size: size,
                        description: content.replace(new RegExp(size), '').trim(),
                        dialogues: [],
                        action: '',
                        imageUrl: null,
                        status: 'pending'
                    };
                } else if (currentShot) {
                    const dialogueMatch = line.match(/^([^ï¼š:]+)[ï¼š:](.+)$/);
                    if (dialogueMatch) {
                        currentShot.dialogues.push({
                            character: dialogueMatch[1].trim(),
                            line: dialogueMatch[2].trim()
                        });
                    } else {
                        currentShot.action += (currentShot.action ? ' ' : '') + line.trim();
                    }
                }
            });

            if (currentShot) shots.push(currentShot);
            return shots;
        }

        async function generateStoryboard() {
            const apiKey = document.getElementById('apiKey').value.trim();
            if (!apiKey) {
                alert('è¯·è¾“å…¥ API Key');
                document.getElementById('apiKey').focus();
                return;
            }

            const title = document.getElementById('projectTitle').value || 'æœªå‘½åé¡¹ç›®';
            const scene = document.getElementById('sceneDesc').value || '';
            const resolution = document.getElementById('resolution').value;
            const aspectRatio = document.getElementById('aspectRatio').value;
            
            currentShots = parseScript();
            if (currentShots.length === 0) {
                alert('æœªèƒ½è§£æåˆ°é•œå¤´ä¿¡æ¯ï¼Œè¯·æ£€æŸ¥å‰§æœ¬æ ¼å¼');
                return;
            }

            isGenerating = true;
            document.getElementById('generateBtn').disabled = true;
            document.getElementById('generateBtn').innerHTML = '<span class="animate-pulse">ç”Ÿæˆä¸­...</span>';
            
            renderStoryboard(title, scene, true);
            
            // Generate images sequentially
            for (let i = 0; i < currentShots.length; i++) {
                await generateImageForShot(i, apiKey, resolution, aspectRatio, scene);
                renderStoryboard(title, scene, true);
            }
            
            isGenerating = false;
            document.getElementById('generateBtn').disabled = false;
            document.getElementById('generateBtn').innerHTML = '<span>ç”Ÿæˆåˆ†é•œç¨¿</span><span class="mono text-xs opacity-50">â†’</span>';
        }

        async function generateImageForShot(index, apiKey, resolution, aspectRatio, sceneContext) {
            const shot = currentShots[index];
            shot.status = 'generating';
            
            try {
                // Construct prompt for storyboard style
                const prompt = `Black and white storyboard sketch, cinematic composition, ${shot.size} shot, ${shot.description}. ${shot.action}. Scene context: ${sceneContext}. Style: high contrast black and white, film noir lighting, rough pencil sketch texture, professional film storyboard aesthetic, dramatic shadows, minimalist details, 35mm film grain texture, monochrome palette only`;
                
                const sizeMap = {
                    '1024x1024': '1024x1024',
                    '2048x2048': '1024x1024', // Nano Banana Pro uses 1024 and upscales
                    '4096x4096': '1024x1024'
                };

                const response = await fetch('https://api.apiyi.com/v1/images/generations', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: 'gemini-3-pro-image-preview',
                        prompt: prompt,
                        n: 1,
                        size: sizeMap[resolution] || '1024x1024',
                        quality: 'high',
                        response_format: 'url'
                    })
                });

                if (!response.ok) {
                    throw new Error(`API Error: ${response.status}`);
                }

                const data = await response.json();
                if (data.data && data.data[0] && data.data[0].url) {
                    shot.imageUrl = data.data[0].url;
                    shot.status = 'completed';
                } else {
                    throw new Error('Invalid response format');
                }
            } catch (error) {
                console.error('Generation error:', error);
                shot.status = 'error';
                shot.error = error.message;
            }
        }

        function renderStoryboard(title, scene, isLoading = false) {
            const container = document.getElementById('storyboardContainer');
            const timestamp = new Date().toLocaleDateString('zh-CN');
            
            let html = `
                <div class="border-b-2 border-white pb-4 mb-8 flex justify-between items-end bg-black/50 p-4 backdrop-blur">
                    <div>
                        <h1 class="text-3xl font-black tracking-tight mb-1">${title}</h1>
                        <p class="text-neutral-500 text-sm mono">${scene}</p>
                    </div>
                    <div class="text-right text-xs text-neutral-600 mono">
                        <div>GENERATED: ${timestamp}</div>
                        <div>SHOTS: ${currentShots.length}</div>
                        <div>MODEL: NANO_BANANA_PRO</div>
                    </div>
                </div>
                <div class="grid grid-cols-1 xl:grid-cols-2 gap-6">
            `;

            currentShots.forEach((shot, index) => {
                const sizeAbbr = {
                    'ç‰¹å†™': 'CU', 'è¿‘æ™¯': 'MCU', 'ä¸­æ™¯': 'MS', 
                    'å…¨æ™¯': 'FS', 'è¿œæ™¯': 'LS'
                }[shot.size] || 'MS';

                const statusColor = {
                    'pending': 'bg-neutral-800',
                    'generating': 'bg-blue-900/20 border-blue-500/50',
                    'completed': 'bg-neutral-900',
                    'error': 'bg-red-900/20 border-red-500/50'
                }[shot.status];

                html += `
                    <div class="shot-card ${statusColor} p-0 overflow-hidden relative group">
                        ${shot.status === 'generating' ? '<div class="absolute inset-0 loading-scan z-10"></div>' : ''}
                        
                        <!-- Image Area -->
                        <div class="aspect-video bg-black relative overflow-hidden border-b border-neutral-800">
                            ${shot.imageUrl ? `
                                <img src="${shot.imageUrl}" alt="Shot ${shot.number}" 
                                    class="w-full h-full object-cover generated-image opacity-90 hover:opacity-100 transition-opacity">
                                <div class="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent opacity-0 group-hover:opacity-100 transition-opacity"></div>
                            ` : `
                                <div class="w-full h-full flex items-center justify-center text-neutral-700">
                                    ${shot.status === 'generating' ? 
                                        '<div class="text-center"><div class="animate-spin w-8 h-8 border-2 border-white border-t-transparent rounded-full mx-auto mb-2"></div><span class="text-xs mono">GENERATING...</span></div>' : 
                                        '<span class="text-4xl opacity-20">ğŸ¬</span>'
                                    }
                                </div>
                            `}
                            <div class="absolute top-2 right-2 bg-black/80 text-white text-xs font-bold px-2 py-1 mono border border-white/20">
                                ${shot.number}
                            </div>
                        </div>

                        <!-- Info Area -->
                        <div class="p-5 space-y-3">
                            <div class="flex justify-between items-start">
                                <div class="flex gap-3">
                                    <div class="w-12 h-12 border-2 border-white flex items-center justify-center font-black text-lg mono bg-black text-white">
                                        ${sizeAbbr}
                                    </div>
                                    <div>
                                        <div class="text-xs text-neutral-500 uppercase tracking-widest">æ™¯åˆ«</div>
                                        <div class="font-bold text-lg">${shot.size}</div>
                                    </div>
                                </div>
                                ${shot.status === 'error' ? '<span class="text-xs text-red-500 mono">ERROR</span>' : ''}
                            </div>

                            <div class="border-l-2 border-white/30 pl-4 space-y-2">
                                <div>
                                    <div class="text-xs text-neutral-500 uppercase tracking-wider mb-1">ç”»é¢æè¿°</div>
                                    <p class="text-sm leading-relaxed text-neutral-300">${shot.description}</p>
                                </div>
                                ${shot.action ? `
                                    <div>
                                        <div class="text-xs text-neutral-500 uppercase tracking-wider mb-1">åŠ¨ä½œ</div>
                                        <p class="text-xs text-neutral-400 italic">${shot.action}</p>
                                    </div>
                                ` : ''}
                            </div>

                            ${shot.dialogues.length > 0 ? `
                                <div class="bg-black/50 border border-neutral-800 p-3 mt-3">
                                    <div class="text-xs text-neutral-500 uppercase tracking-wider mb-2">å¯¹ç™½</div>
                                    ${shot.dialogues.map(d => `
                                        <div class="mb-2 last:mb-0">
                                            <span class="text-xs font-bold text-white uppercase tracking-wider">${d.character}</span>
                                            <p class="text-sm text-neutral-300 mt-0.5">"${d.line}"</p>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : ''}

                            <div class="pt-3 border-t border-neutral-800 flex justify-between items-center text-xs text-neutral-600 mono">
                                <span>SHOT_${String(shot.number).padStart(2, '0')}</span>
                                <span>[${index + 1}/${currentShots.length}]</span>
                            </div>
                        </div>
                    </div>
                `;
            });

            html += '</div>';
            container.innerHTML = html;
        }

        function exportStoryboard() {
            if (currentShots.length === 0) {
                alert('è¯·å…ˆç”Ÿæˆåˆ†é•œç¨¿');
                return;
            }
            window.print();
        }

        // Auto-save API key to localStorage (optional)
        document.getElementById('apiKey').addEventListener('blur', function() {
            if (this.value) localStorage.setItem('nano_banana_api_key', this.value);
        });
        
        // Load saved API key
        window.addEventListener('load', function() {
            const saved = localStorage.getItem('nano_banana_api_key');
            if (saved) document.getElementById('apiKey').value = saved;
        });
    </script>
</body>
</html>
