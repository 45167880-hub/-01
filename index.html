<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI åˆ†é•œç”Ÿæˆå™¨ - 12æ ¼ç”µå½±åˆ†é•œ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;700;900&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        * {
            scrollbar-width: thin;
            scrollbar-color: #333 #0a0a0a;
        }
        body {
            font-family: 'Noto Serif SC', serif;
            background-color: #050505;
            color: #e5e5e5;
            overflow: hidden;
            font-size: 12px;
        }
        .mono { font-family: 'JetBrains Mono', monospace; }
        .storyboard-grid {
            background-image: 
                linear-gradient(rgba(255,255,255,0.02) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255,255,255,0.02) 1px, transparent 1px);
            background-size: 20px 20px;
        }

        .left-panel {
            height: 100vh;
            overflow-y: auto;
            overflow-x: hidden;
            padding-bottom: 100px;
        }
        .left-panel::-webkit-scrollbar { width: 4px; }
        .left-panel::-webkit-scrollbar-track { background: #0a0a0a; }
        .left-panel::-webkit-scrollbar-thumb { background: #333; border-radius: 2px; }

        .scene-item {
            background: #111;
            border: 1px solid #333;
            padding: 10px;
            margin-bottom: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .scene-item:hover {
            border-color: #555;
            background: #1a1a1a;
        }
        .scene-item.active {
            border-color: #fff;
            background: #222;
        }
        .scene-item.selected-for-generate {
            border-left: 3px solid #10b981;
        }
        .scene-item.has-generated {
            border-right: 3px solid #3b82f6;
        }

        .scene-checkbox {
            margin-right: 8px;
            cursor: pointer;
        }

        /* å•å¼ åˆ†é•œå±•ç¤º - 16:9 æ¯”ä¾‹ */
        .single-frame {
            background: #111;
            border: 1px solid #333;
            margin-bottom: 24px;
            break-inside: avoid;
            transition: all 0.2s;
        }
        .single-frame:hover {
            border-color: #444;
        }
        
        /* 16:9 ç”»é¢å®¹å™¨ */
        .frame-image-container {
            position: relative;
            width: 100%;
            aspect-ratio: 16/9;
            background: #000;
            overflow: hidden;
        }
        
        .frame-image-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }
        
        /* å·¦ä¸Šè§’ä¿¡æ¯æ ‡ç­¾ */
        .frame-overlay-info {
            position: absolute;
            top: 12px;
            left: 12px;
            display: flex;
            gap: 8px;
            pointer-events: none;
            z-index: 10;
        }
        
        .info-tag {
            background: rgba(0, 0, 0, 0.85);
            color: #fff;
            padding: 6px 12px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px;
            font-weight: 700;
            border-left: 3px solid #fff;
        }
        
        .info-tag.shot-num {
            background: rgba(255, 255, 255, 0.95);
            color: #000;
            border-left: 3px solid #000;
        }

        /* å¯ç¼–è¾‘åŒºåŸŸ */
        .frame-edit-area {
            padding: 16px;
            background: #0a0a0a;
        }
        
        .edit-field {
            margin-bottom: 12px;
        }
        
        .edit-field:last-child {
            margin-bottom: 0;
        }
        
        .edit-label {
            font-size: 10px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 6px;
            display: block;
        }
        
        .edit-textarea {
            width: 100%;
            background: #111;
            border: 1px solid #333;
            color: #e5e5e5;
            padding: 10px 12px;
            font-size: 13px;
            line-height: 1.6;
            resize: vertical;
            min-height: 60px;
            font-family: inherit;
            transition: border-color 0.2s;
        }
        
        .edit-textarea:focus {
            outline: none;
            border-color: #555;
            background: #151515;
        }
        
        .edit-textarea.audio-field {
            min-height: 40px;
            font-size: 12px;
            color: #aaa;
        }

        /* æ“ä½œæŒ‰é’® */
        .frame-actions {
            display: flex;
            gap: 8px;
            padding: 12px 16px;
            background: #111;
            border-top: 1px solid #222;
        }

        .image-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0,0,0,0.95);
            z-index: 200;
            justify-content: center;
            align-items: center;
            cursor: zoom-out;
        }
        .image-modal.active { display: flex; }
        .image-modal img {
            max-width: 90vw;
            max-height: 90vh;
            object-fit: contain;
            cursor: default;
        }

        .drop-zone {
            border: 2px dashed #444;
            background: rgba(255,255,255,0.02);
            transition: all 0.3s;
        }
        .drop-zone.drag-over {
            border-color: #fff;
            background: rgba(255,255,255,0.08);
        }
        .drop-zone.success {
            border-color: #10b981;
            background: rgba(16, 185, 129, 0.1);
        }

        .btn-primary {
            background: #fff;
            color: #000;
            border: none;
            padding: 12px 24px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 13px;
        }
        .btn-primary:hover:not(:disabled) { background: #ccc; }
        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: transparent;
            border: 1px solid #555;
            color: #aaa;
            padding: 8px 16px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 12px;
        }
        .btn-secondary:hover {
            border-color: #fff;
            color: #fff;
        }
        
        .btn-small {
            padding: 6px 12px;
            font-size: 11px;
        }

        .btn-analyze {
            background: linear-gradient(135deg, #1a1a1a 0%, #0a0a0a 100%);
            border: 1px solid #444;
            color: #fff;
            padding: 10px 20px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 12px;
        }
        .btn-analyze:hover:not(:disabled) { border-color: #10b981; }
        .btn-analyze:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .control-group {
            background: #0a0a0a;
            border: 1px solid #333;
            padding: 12px;
            margin-bottom: 10px;
        }
        .control-label {
            font-size: 10px;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 8px;
            display: block;
        }

        select, input[type="text"], input[type="password"] {
            width: 100%;
            background: #111;
            border: 1px solid #444;
            color: #fff;
            padding: 8px;
            font-size: 12px;
        }
        select:focus, input:focus {
            outline: none;
            border-color: #fff;
        }

        .progress-container {
            background: #111;
            border: 1px solid #333;
            padding: 12px;
            margin-top: 10px;
        }
        .progress-bar {
            height: 4px;
            background: #333;
            overflow: hidden;
            margin-bottom: 8px;
        }
        .progress-fill {
            height: 100%;
            background: #fff;
            transition: width 0.3s;
        }
        .progress-text {
            font-size: 11px;
            color: #888;
            text-align: center;
        }

        .status-badge {
            display: inline-block;
            padding: 2px 8px;
            font-size: 10px;
            border-radius: 2px;
            margin-left: 8px;
        }
        .status-pending { background: #333; color: #888; }
        .status-generated { background: #1e3a5f; color: #60a5fa; }
        .status-error { background: #450a0a; color: #f87171; }
        
        .generating-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 20;
        }
        
        .generating-text {
            color: #fff;
            font-family: 'JetBrains Mono', monospace;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid #333;
            border-top-color: #fff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
<base target="_blank">
</head>
<body class="storyboard-grid">
    <div class="image-modal" id="imageModal" onclick="closeImageModal(event)">
        <img id="modalImage" src="" alt="æ”¾å¤§å›¾ç‰‡">
    </div>

    <div class="flex h-screen">
        <!-- å·¦ä¾§å·¥ä½œæ  -->
        <div class="left-panel w-80 border-r border-neutral-800 bg-black/80 backdrop-blur">
            <div class="p-4 space-y-3">

                <!-- Header -->
                <div class="flex items-center gap-2 pb-3 border-b border-neutral-800">
                    <div class="w-8 h-8 bg-white text-black flex items-center justify-center font-black text-sm mono">12</div>
                    <div>
                        <h1 class="text-sm font-black tracking-tight">CINEMA<span class="text-neutral-500">_BOARD</span></h1>
                        <p class="text-[10px] text-neutral-500 mono">12æ ¼ç”µå½±åˆ†é•œ</p>
                    </div>
                </div>

                <!-- API é…ç½® -->
                <div class="control-group">
                    <label class="control-label">API é…ç½®</label>
                    <input type="password" id="apiKey" placeholder="è¾“å…¥ APIæ˜“ Key..." class="mb-2">
                    <select id="apiEndpoint">
                        <option value="https://api.apiyi.com/v1" selected>api.apiyi.com</option>
                        <option value="https://vip.apiyi.com/v1">vip.apiyi.com</option>
                    </select>
                </div>

                <!-- å‰§æœ¬ä¸Šä¼  -->
                <div class="space-y-1">
                    <label class="control-label">å‰§æœ¬ä¸Šä¼ </label>
                    <div class="drop-zone p-3 text-center rounded cursor-pointer" id="dropZone">
                        <div class="text-lg mb-1" id="dropIcon">ğŸ“„</div>
                        <p class="text-xs text-neutral-400" id="dropText">æ‹–æ‹½ Word æ–‡æ¡£</p>
                        <p class="text-[10px] text-neutral-600" id="dropSubtext">.docx / .txt</p>
                        <input type="file" id="fileInput" accept=".docx,.doc,.txt" class="hidden">
                    </div>
                </div>

                <!-- AI è§£ææŒ‰é’® -->
                <button onclick="analyzeScript()" id="analyzeBtn" disabled class="btn-analyze w-full">
                    <span id="analyzeBtnText">ğŸ§  AI è§£æåœºæ¬¡</span>
                </button>

                <!-- ç‰‡å -->
                <div class="control-group">
                    <label class="control-label">ç‰‡å</label>
                    <input type="text" id="projectTitle" placeholder="è¾“å…¥ç‰‡å...">
                </div>

                <!-- åœºæ¬¡åˆ—è¡¨ -->
                <div id="scenesList" class="hidden">
                    <label class="control-label flex justify-between">
                        <span>åœºæ¬¡åˆ—è¡¨</span>
                        <span class="text-[10px] text-neutral-600">âœ“=ç”Ÿæˆ âœ“=é€‰æ‹©</span>
                    </label>
                    <div id="scenesContainer" class="max-h-64 overflow-y-auto">
                    </div>
                </div>

                <!-- ç”ŸæˆæŒ‰é’® -->
                <button onclick="generate12GridStoryboard()" id="generateBtn" disabled class="btn-primary w-full">
                    ç”Ÿæˆ12æ ¼åˆ†é•œ
                </button>

                <!-- è¿›åº¦æ˜¾ç¤º -->
                <div id="progressContainer" class="progress-container hidden">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                    </div>
                    <div class="progress-text" id="progressText">å‡†å¤‡ç”Ÿæˆ...</div>
                </div>

                <!-- è¯´æ˜ -->
                <div class="text-[10px] text-neutral-600 space-y-1 pt-3 border-t border-neutral-800">
                    <p>â€¢ æ¯å¼ å¤§å›¾ç”Ÿæˆ 12 å¼ åˆ†é•œï¼ˆ3Ã—4ï¼‰</p>
                    <p>â€¢ æ ¼å­æ›´å¤§ï¼Œå†…å®¹æ›´å‡†ç¡®</p>
                    <p>â€¢ ç‚¹å‡»åˆ†é•œå¯æ”¾å¤§æŸ¥çœ‹</p>
                    <p>â€¢ ç¼–è¾‘æ–‡å­—åå¯é‡æ–°ç”Ÿæˆå•å¼ </p>
                </div>
            </div>
        </div>

        <!-- å³ä¾§åˆ†é•œé¢„è§ˆåŒº - ç›´æ¥æ˜¾ç¤ºå•å¼ åˆ†é•œ -->
        <div class="flex-1 h-screen overflow-y-auto p-6" id="rightPanel">
            <div id="storyboardContainer">
                <div class="flex flex-col items-center justify-center h-full text-neutral-600 min-h-[60vh]">
                    <div class="text-4xl mb-3 opacity-20">ğŸ¬</div>
                    <p class="text-sm mb-1">ç­‰å¾…å‰§æœ¬</p>
                    <p class="text-xs text-center">æ‹–æ‹½ Word æ–‡æ¡£ä¸Šä¼ å¹¶è§£æåœºæ¬¡</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let scenes = [];
        let currentSceneIndex = -1;
        let rawScriptText = '';
        let isGenerating = false;
        
        // é…ç½®ï¼šæ¯å¼ å¤§å›¾åŒ…å«çš„åˆ†é•œæ•°é‡ï¼ˆ3è¡Œ x 4åˆ— = 12ï¼‰
        const GRID_ROWS = 3;
        const GRID_COLS = 4;
        const FRAMES_PER_SHEET = GRID_ROWS * GRID_COLS; // 12

        // æ–‡ä»¶ä¸Šä¼ å¤„ç†
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');

        dropZone.addEventListener('click', () => fileInput.click());
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, preventDefaults, false);
        });
        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }
        dropZone.addEventListener('dragenter', () => dropZone.classList.add('drag-over'));
        dropZone.addEventListener('dragleave', () => dropZone.classList.remove('drag-over'));
        dropZone.addEventListener('drop', (e) => {
            dropZone.classList.remove('drag-over');
            const files = e.dataTransfer.files;
            if (files.length > 0) handleFile(files[0]);
        });
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) handleFile(e.target.files[0]);
        });

        async function handleFile(file) {
            const dropIcon = document.getElementById('dropIcon');
            const dropText = document.getElementById('dropText');
            const dropSubtext = document.getElementById('dropSubtext');

            dropZone.classList.add('drag-over');

            try {
                let text = '';
                if (file.name.endsWith('.docx') || file.name.endsWith('.doc')) {
                    const arrayBuffer = await file.arrayBuffer();
                    const result = await mammoth.extractRawText({ arrayBuffer });
                    text = result.value;
                } else {
                    text = await file.text();
                }

                rawScriptText = text;

                dropZone.classList.remove('drag-over');
                dropZone.classList.add('success');
                dropIcon.textContent = 'âœ…';
                dropText.textContent = file.name;
                dropSubtext.textContent = `${(file.size/1024).toFixed(1)} KB`;
                document.getElementById('analyzeBtn').disabled = false;

                const titleMatch = text.match(/^(.*?)(?:\n|å‰§æœ¬|æ•…äº‹)/);
                if (titleMatch) {
                    document.getElementById('projectTitle').value = titleMatch[1].trim().substring(0, 30);
                }
            } catch (error) {
                dropZone.classList.remove('drag-over');
                dropIcon.textContent = 'âŒ';
                dropText.textContent = 'å¤±è´¥';
            }
        }

        // è§£æå‰§æœ¬
        async function analyzeScript() {
            const apiKey = document.getElementById('apiKey').value.trim();
            if (!apiKey) { alert('è¯·è¾“å…¥ API Key'); return; }
            if (!rawScriptText) { alert('è¯·å…ˆä¸Šä¼ å‰§æœ¬'); return; }

            const btn = document.getElementById('analyzeBtn');
            const btnText = document.getElementById('analyzeBtnText');
            btn.disabled = true;
            btnText.textContent = 'åˆ†æä¸­...';

            try {
                const baseUrl = document.getElementById('apiEndpoint').value;

                const response = await fetch(`${baseUrl}/chat/completions`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: 'gemini-2.5-pro-preview-03-25',
                        messages: [{
                            role: 'user',
                            content: `åˆ†æå‰§æœ¬ï¼ŒæŒ‰åœºæ¬¡æ‹†åˆ†ã€‚è¿”å›JSONï¼š\n\n${rawScriptText.substring(0, 10000)}\n\næ ¼å¼ï¼š{\n  "title": "ç‰‡å",\n  "scenes": [{\n    "id": 1,\n    "title": "åœºæ¬¡æ ‡é¢˜",\n    "location": "åœ°ç‚¹",\n    "time": "æ—¶é—´",\n    "characters": ["è§’è‰²1", "è§’è‰²2"],\n    "shots": [{\n      "number": "01",\n      "camera": "è¿é•œç±»å‹",\n      "content": "ç”»é¢å†…å®¹",\n      "audio": "éŸ³æ•ˆ"\n    }]\n  }]\n}\næ³¨æ„ï¼šè¿é•œç±»å‹è¦ä¸“ä¸šï¼ˆç‰¹å†™/è¿‘æ™¯/ä¸­æ™¯/å…¨æ™¯/è¿œæ™¯/æ¨/æ‹‰/æ‘‡/ç§»/è·Ÿ/å‡é™ç­‰ï¼‰ï¼Œåªè¿”å›JSONã€‚`
                        }],
                        temperature: 0.7
                    })
                });

                if (!response.ok) throw new Error(`HTTP ${response.status}`);

                const data = await response.json();
                const content = data.choices[0].message.content;
                const jsonMatch = content.match(/\{[\s\S]*\}/);

                if (jsonMatch) {
                    const parsed = JSON.parse(jsonMatch[0]);
                    applyParsedScenes(parsed);
                }
            } catch (error) {
                alert('è§£æå¤±è´¥: ' + error.message);
                btn.disabled = false;
                btnText.textContent = 'ğŸ§  AI è§£æåœºæ¬¡';
            }
        }

        function applyParsedScenes(data) {
            if (data.title) document.getElementById('projectTitle').value = data.title;

            if (data.scenes && data.scenes.length > 0) {
                scenes = data.scenes.map((scene, idx) => ({
                    ...scene,
                    selected: idx === 0,
                    generated: false,
                    shots: scene.shots.map((shot, sIdx) => ({
                        ...shot,
                        id: Date.now() + idx * 100 + sIdx,
                        generatedImage: null,
                        status: 'pending',
                        isGenerating: false
                    })),
                    gridSheets: []
                }));

                currentSceneIndex = 0;

                renderScenesList();
                renderCurrentScene();

                document.getElementById('scenesList').classList.remove('hidden');
                document.getElementById('generateBtn').disabled = false;
                document.getElementById('analyzeBtnText').textContent = `âœ… ${scenes.length}ä¸ªåœºæ¬¡`;
            }
        }

        function renderScenesList() {
            const container = document.getElementById('scenesContainer');
            container.innerHTML = scenes.map((scene, index) => {
                const hasGenerated = scene.generated ? 'has-generated' : '';
                const statusBadge = scene.generated 
                    ? '<span class="status-badge status-generated">å·²ç”Ÿæˆ</span>' 
                    : '<span class="status-badge status-pending">æœªç”Ÿæˆ</span>';
                
                const sheetCount = Math.ceil(scene.shots.length / FRAMES_PER_SHEET);

                return `
                <div class="scene-item ${index === currentSceneIndex ? 'active' : ''} ${scene.selected ? 'selected-for-generate' : ''} ${hasGenerated}" 
                     onclick="selectScene(${index})">
                    <div class="flex items-start">
                        <input type="checkbox" class="scene-checkbox" 
                               ${scene.selected ? 'checked' : ''} 
                               onclick="event.stopPropagation(); toggleSceneSelection(${index})">
                        <div class="flex-1">
                            <div class="font-bold text-sm flex items-center">
                                åœºæ¬¡ ${scene.id}ï¼š${scene.location}
                                ${statusBadge}
                            </div>
                            <div class="text-[10px] text-neutral-500">${scene.time} Â· ${scene.shots.length}ä¸ªé•œå¤´ Â· ${sheetCount}å¼ å¤§å›¾</div>
                        </div>
                    </div>
                </div>
            `}).join('');
        }

        function selectScene(index) {
            currentSceneIndex = index;
            renderScenesList();
            renderCurrentScene();
        }

        function toggleSceneSelection(index) {
            scenes[index].selected = !scenes[index].selected;
            renderScenesList();
        }

        // ç”Ÿæˆ12æ ¼åˆ†é•œ
        async function generate12GridStoryboard() {
            const apiKey = document.getElementById('apiKey').value.trim();
            if (!apiKey) { alert('è¯·è¾“å…¥ API Key'); return; }

            const selectedScenes = scenes.filter(s => s.selected);
            if (selectedScenes.length === 0) { alert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªåœºæ¬¡'); return; }

            isGenerating = true;
            const btn = document.getElementById('generateBtn');
            btn.disabled = true;
            btn.textContent = 'ç”Ÿæˆä¸­...';

            document.getElementById('progressContainer').classList.remove('hidden');

            try {
                for (let i = 0; i < selectedScenes.length; i++) {
                    const scene = selectedScenes[i];
                    const sceneIdx = scenes.indexOf(scene);

                    updateProgress(i / selectedScenes.length, `æ­£åœ¨ç”Ÿæˆåœºæ¬¡ ${scene.id}... (${i+1}/${selectedScenes.length})`);

                    await generateScene12Grid(sceneIdx, apiKey);

                    scenes[sceneIdx].generated = true;
                    renderScenesList();
                }

                updateProgress(1, 'ç”Ÿæˆå®Œæˆï¼');
                setTimeout(() => {
                    document.getElementById('progressContainer').classList.add('hidden');
                }, 2000);

            } catch (error) {
                alert('ç”Ÿæˆå‡ºé”™: ' + error.message);
                updateProgress(0, 'ç”Ÿæˆå¤±è´¥');
            }

            isGenerating = false;
            btn.disabled = false;
            btn.textContent = 'ç”Ÿæˆ12æ ¼åˆ†é•œ';

            if (currentSceneIndex !== -1) {
                renderCurrentScene();
            }
        }

        function updateProgress(ratio, text) {
            document.getElementById('progressFill').style.width = `${ratio * 100}%`;
            document.getElementById('progressText').textContent = text;
        }

        async function generateScene12Grid(sceneIdx, apiKey) {
            const scene = scenes[sceneIdx];
            const shots = scene.shots;
            const totalSheets = Math.ceil(shots.length / FRAMES_PER_SHEET);

            scene.gridSheets = [];

            const baseUrl = document.getElementById('apiEndpoint').value;

            for (let sheetIdx = 0; sheetIdx < totalSheets; sheetIdx++) {
                const startIdx = sheetIdx * FRAMES_PER_SHEET;
                const endIdx = Math.min(startIdx + FRAMES_PER_SHEET, shots.length);
                const sheetShots = shots.slice(startIdx, endIdx);

                const prompt = build12GridPrompt(scene, sheetShots, sheetIdx);

                try {
                    // ç”Ÿæˆ 16:9 çš„å®½å›¾ï¼Œ3è¡Œ x 4åˆ—å¸ƒå±€
                    // å°ºå¯¸é€‰æ‹© 1536 x 864 (16:9)ï¼Œè¿™æ ·åˆ‡å‰²åæ¯å¼ æ˜¯ 384 x 288 (4:3? ä¸å¯¹)
                    // é‡æ–°è®¡ç®—ï¼šè¦æ¯å¼ åˆ†é•œæ˜¯ 16:9
                    // å¦‚æœå¤§å›¾æ˜¯ 4åˆ— x 3è¡Œï¼Œä¸”æ¯å¼ åˆ†é•œæ˜¯ 16:9
                    // é‚£ä¹ˆå¤§å›¾å®½åº¦ = 16 * 4 = 64 ä»½ï¼Œé«˜åº¦ = 9 * 3 = 27 ä»½
                    // æ¯”ä¾‹ = 64:27 â‰ˆ 2.37:1ï¼ˆè¶…å®½å±ï¼‰
                    // é€‰æ‹© 1920 x 810 æ¥è¿‘è¿™ä¸ªæ¯”ä¾‹
                    
                    const response = await fetch(`${baseUrl}/images/generations`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${apiKey}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            model: 'gemini-3-pro-image-preview',
                            prompt: prompt,
                            size: '1920x1080',  // 16:9ï¼Œç„¶ååœ¨æç¤ºè¯ä¸­æ˜ç¡® 3x4 å¸ƒå±€
                            response_format: 'b64_json'
                        })
                    });

                    if (!response.ok) {
                        const err = await response.json();
                        throw new Error(err.error?.message || `HTTP ${response.status}`);
                    }

                    const data = await response.json();

                    if (data.data && data.data[0] && data.data[0].b64_json) {
                        const fullImage = `data:image/png;base64,${data.data[0].b64_json}`;

                        // åˆ‡å‰²æˆ12å¼  16:9 åˆ†é•œ
                        const cutFrames = await cut12GridImage(fullImage, sheetShots, startIdx);

                        scene.gridSheets.push({
                            sheetIndex: sheetIdx,
                            fullImage: fullImage,
                            frames: cutFrames
                        });

                        // æ›´æ–°æ¯ä¸ªshotçš„çŠ¶æ€å’Œå›¾ç‰‡
                        sheetShots.forEach((shot, idx) => {
                            if (cutFrames[idx] && !cutFrames[idx].empty) {
                                shot.status = 'completed';
                                shot.generatedImage = cutFrames[idx].image;
                            }
                        });
                        
                        // å®æ—¶æ›´æ–°æ˜¾ç¤º
                        renderCurrentScene();
                    }
                } catch (error) {
                    console.error('ç”Ÿæˆé”™è¯¯:', error);
                    sheetShots.forEach(shot => {
                        shot.status = 'error';
                    });
                }
            }
        }

        function build12GridPrompt(scene, shots, sheetIndex) {
            const characters = scene.characters ? scene.characters.join(', ') : 'ä¸»è¦è§’è‰²';

            // æ„å»º 3x4 ç½‘æ ¼æè¿°
            let gridDesc = [];
            for (let i = 0; i < shots.length; i++) {
                const row = Math.floor(i / GRID_COLS) + 1;
                const col = (i % GRID_COLS) + 1;
                const shot = shots[i];
                gridDesc.push(`Position [${row},${col}]: ${shot.camera} shot - ${shot.content}`);
            }

            return `Professional film storyboard layout, 3 rows by 4 columns grid (12 frames total), arranged left-to-right, top-to-bottom. Each frame is 16:9 widescreen aspect ratio. ${gridDesc.join('. ')}. Characters: ${characters} (consistent appearance). Style: Black and white cinematic storyboard, detailed pencil sketch, dramatic lighting, clear panel borders separating each frame, professional film production quality. The layout must be exactly 3 rows and 4 columns, evenly spaced.`;
        }

        // åˆ‡å‰²12æ ¼å›¾ç‰‡ - ä» 16:9 å¤§å›¾åˆ‡å‰²å‡º 12 å¼  16:9 åˆ†é•œï¼ˆ3è¡Œ x 4åˆ—ï¼‰
        async function cut12GridImage(fullImageUrl, shots, startIdx) {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = () => {
                    const frames = [];
                    
                    // å¤§å›¾æ˜¯ 1920x1080 (16:9)
                    // æˆ‘ä»¬éœ€è¦ 4åˆ— x 3è¡Œ çš„ç½‘æ ¼
                    // æ¯å¼ åˆ†é•œåº”è¯¥æ˜¯ 16:9 æ¯”ä¾‹
                    
                    // è®¡ç®—ï¼šå¦‚æœæ¨ªå‘4å¼ 16:9ï¼Œçºµå‘3å¼ 16:9
                    // é‚£ä¹ˆå¤§å›¾æ¯”ä¾‹åº”è¯¥æ˜¯ (16*4) : (9*3) = 64:27 â‰ˆ 2.37:1
                    // ä½† 1920:1080 = 16:9 = 1.78:1
                    // æ‰€ä»¥æˆ‘ä»¬éœ€è¦åœ¨ 16:9 çš„å¤§å›¾å†…ï¼Œä»¥å®½åº¦ä¸ºåŸºå‡†ï¼Œè®¡ç®—åˆç†çš„åˆ‡å‰²æ–¹å¼
                    
                    // å®é™…ç­–ç•¥ï¼šå°†å¤§å›¾è§†ä¸º 4x3 ç½‘æ ¼ï¼Œæ¯ä¸ªæ ¼å­è¿‘ä¼¼ 16:9
                    // æ ¼å­å®½åº¦ = 1920 / 4 = 480
                    // æ ¼å­é«˜åº¦ = 1080 / 3 = 360
                    // æ¯”ä¾‹ = 480/360 = 1.333... (4:3)ï¼Œè¿™ä¸æ˜¯ 16:9
                    
                    // ä¿®æ­£ï¼šä¸ºäº†è®©æ¯å¼ åˆ†é•œæ˜¯ 16:9ï¼Œæˆ‘ä»¬éœ€è¦åœ¨ 16:9 çš„å¤§å›¾å†…
                    // æ¨ªå‘æ’åˆ— 4 å¼ ï¼Œæ¯å¼ å®½åº¦ = æ€»å®½ / 4
                    // æ¯å¼ é«˜åº¦ = æ¯å¼ å®½åº¦ * 9/16
                    // çºµå‘å¯ä»¥æ’åˆ—çš„è¡Œæ•° = æ€»é«˜ / æ¯å¼ é«˜åº¦ = 1080 / (480 * 9/16) = 1080 / 270 = 4è¡Œ
                    
                    // æ‰€ä»¥ 1920x1080 çš„å¤§å›¾ï¼Œå¦‚æœæ¯å¼ åˆ†é•œä¿æŒ 16:9ï¼Œå¯ä»¥æ’åˆ— 4åˆ— x 4è¡Œ = 16å¼ 
                    // ä½†æˆ‘ä»¬æƒ³è¦ 12 å¼ ï¼ˆ3x4ï¼‰ï¼Œè®©æ¯å¼ åˆ†é•œæ›´å¤§ä¸€äº›
                    
                    // é‡æ–°è®¡ç®— 12 å¼ ï¼ˆ3è¡Œ x 4åˆ—ï¼‰åœ¨ 16:9 å¤§å›¾ä¸­çš„å¸ƒå±€ï¼š
                    // æ¯å¼ åˆ†é•œå®½åº¦ = 1920 / 4 = 480px
                    // æ¯å¼ åˆ†é•œé«˜åº¦ = 480 * 9/16 = 270px
                    // 3è¡Œæ€»é«˜åº¦ = 270 * 3 = 810px
                    // ä¸Šä¸‹è¾¹è· = (1080 - 810) / 2 = 135px
                    
                    const cellWidth = img.width / GRID_COLS;  // 480px
                    const cellHeight = cellWidth * 9 / 16;    // 270px (ä¿æŒ16:9)
                    const totalGridHeight = cellHeight * GRID_ROWS; // 810px
                    const verticalOffset = (img.height - totalGridHeight) / 2; // 135px ä¸Šä¸‹å±…ä¸­

                    for (let i = 0; i < FRAMES_PER_SHEET; i++) {
                        if (i >= shots.length) {
                            frames.push({ index: startIdx + i, shot: null, image: null, empty: true });
                            continue;
                        }

                        const row = Math.floor(i / GRID_COLS);
                        const col = i % GRID_COLS;
                        
                        const sourceX = col * cellWidth;
                        const sourceY = row * cellHeight + verticalOffset;
                        
                        // åˆ›å»ºä¸´æ—¶canvasè¿›è¡Œè£å‰ª
                        const canvas = document.createElement('canvas');
                        canvas.width = cellWidth;
                        canvas.height = cellHeight;
                        const ctx = canvas.getContext('2d');

                        ctx.drawImage(
                            img,
                            sourceX, sourceY, cellWidth, cellHeight,
                            0, 0, cellWidth, cellHeight
                        );

                        frames.push({
                            index: startIdx + i,
                            shot: shots[i],
                            image: canvas.toDataURL('image/png'),
                            empty: false
                        });
                    }

                    resolve(frames);
                };
                img.src = fullImageUrl;
            });
        }

        // æ¸²æŸ“å½“å‰åœºæ¬¡ - ç›´æ¥æ˜¾ç¤ºå•å¼ åˆ†é•œ
        function renderCurrentScene() {
            const container = document.getElementById('storyboardContainer');

            if (currentSceneIndex === -1 || scenes.length === 0) {
                container.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-full text-neutral-600 min-h-[60vh]">
                        <div class="text-4xl mb-3 opacity-20">ğŸ¬</div>
                        <p class="text-sm">è¯·é€‰æ‹©åœºæ¬¡</p>
                    </div>
                `;
                return;
            }

            const scene = scenes[currentSceneIndex];
            
            // æ”¶é›†æ‰€æœ‰åˆ†é•œï¼ˆä»æ‰€æœ‰sheetsä¸­ï¼‰
            let allFrames = [];
            if (scene.gridSheets && scene.gridSheets.length > 0) {
                scene.gridSheets.forEach(sheet => {
                    sheet.frames.forEach(frame => {
                        if (!frame.empty) {
                            allFrames.push(frame);
                        }
                    });
                });
            }

            let html = `
                <div class="mb-6">
                    <div class="flex justify-between items-end mb-6 pb-4 border-b border-neutral-800">
                        <div>
                            <h2 class="text-2xl font-black tracking-tight">åœºæ¬¡ ${scene.id}ï¼š${scene.location}</h2>
                            <p class="text-neutral-500 text-sm">${scene.time} Â· ${scene.shots.length} ä¸ªé•œå¤´ Â· ${Math.ceil(scene.shots.length/FRAMES_PER_SHEET)} å¼ å¤§å›¾</p>
                            ${scene.characters ? `<p class="text-neutral-600 text-xs mt-2">è§’è‰²ï¼š${scene.characters.join('ã€')}</p>` : ''}
                        </div>
                        ${scene.generated ? `<button onclick="regenerateCurrentScene()" class="btn-secondary">é‡æ–°ç”Ÿæˆæ•´åœº</button>` : ''}
                    </div>
                    
                    <div style="column-count: 2; column-gap: 24px;">
            `;

            // æ˜¾ç¤ºæ‰€æœ‰å•å¼ åˆ†é•œ
            scene.shots.forEach((shot, idx) => {
                const frame = allFrames.find(f => f.index === idx);
                const hasImage = frame && frame.image;
                const isGenerating = shot.isGenerating;
                
                html += `
                    <div class="single-frame" id="frame-${idx}">
                        <div class="frame-image-container" onclick="${hasImage ? `openImageModal('${frame.image}')` : ''}">
                            ${hasImage ? `
                                <img src="${frame.image}" alt="é•œå¤´${idx + 1}">
                            ` : `
                                <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #333; font-size: 14px;">
                                    ç­‰å¾…ç”Ÿæˆ
                                </div>
                            `}
                            
                            ${isGenerating ? `
                                <div class="generating-overlay">
                                    <div class="generating-text">
                                        <div class="spinner"></div>
                                        <span>ç”Ÿæˆä¸­...</span>
                                    </div>
                                </div>
                            ` : ''}
                            
                            <div class="frame-overlay-info">
                                <span class="info-tag shot-num">SHOT ${String(idx + 1).padStart(2, '0')}</span>
                                <span class="info-tag">${shot.camera}</span>
                            </div>
                        </div>
                        
                        <div class="frame-edit-area">
                            <div class="edit-field">
                                <label class="edit-label">ç”»é¢å†…å®¹</label>
                                <textarea class="edit-textarea" 
                                    id="content-${idx}"
                                    onchange="updateShotContent(${currentSceneIndex}, ${idx}, 'content', this.value)"
                                    placeholder="æè¿°ç”»é¢å†…å®¹...">${shot.content}</textarea>
                            </div>
                            <div class="edit-field">
                                <label class="edit-label">éŸ³æ•ˆ / å¯¹ç™½</label>
                                <textarea class="edit-textarea audio-field" 
                                    id="audio-${idx}"
                                    onchange="updateShotContent(${currentSceneIndex}, ${idx}, 'audio', this.value)"
                                    placeholder="éŸ³æ•ˆã€å¯¹ç™½æˆ–éŸ³ä¹...">${shot.audio}</textarea>
                            </div>
                        </div>
                        
                        <div class="frame-actions">
                            <button onclick="regenerateSingleFrame(${currentSceneIndex}, ${idx})" 
                                    class="btn-secondary btn-small" 
                                    ${isGenerating ? 'disabled' : ''}>
                                ${isGenerating ? 'ç”Ÿæˆä¸­...' : 'â™»ï¸ é‡æ–°ç”Ÿæˆæ­¤é•œ'}
                            </button>
                            ${hasImage ? `
                                <button onclick="downloadImage('${frame.image}', 'åœºæ¬¡${scene.id}_é•œå¤´${String(idx+1).padStart(2,'0')}')" 
                                        class="btn-secondary btn-small">
                                    â¬‡ï¸ ä¸‹è½½
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `;
            });

            html += '</div></div>';
            container.innerHTML = html;
        }

        function updateShotContent(sceneIdx, shotIdx, field, value) {
            scenes[sceneIdx].shots[shotIdx][field] = value;
        }

        // é‡æ–°ç”Ÿæˆå•å¼ åˆ†é•œ
        async function regenerateSingleFrame(sceneIdx, shotIdx) {
            const apiKey = document.getElementById('apiKey').value.trim();
            if (!apiKey) { alert('è¯·è¾“å…¥ API Key'); return; }

            const scene = scenes[sceneIdx];
            const shot = scene.shots[shotIdx];
            
            // æ ‡è®°ä¸ºç”Ÿæˆä¸­
            shot.isGenerating = true;
            renderCurrentScene();

            try {
                const baseUrl = document.getElementById('apiEndpoint').value;
                const characters = scene.characters ? scene.characters.join(', ') : 'ä¸»è¦è§’è‰²';
                
                // æ„å»ºå•å¼ åˆ†é•œçš„æç¤ºè¯
                const prompt = `Cinematic film storyboard frame, ${shot.camera} shot. Scene: ${scene.location}, ${scene.time}. Characters: ${characters}. Content: ${shot.content}. Style: Professional film storyboard, black and white sketch, bold outlines, dramatic cinematic lighting, detailed composition, 16:9 aspect ratio, 4K quality.`;

                const response = await fetch(`${baseUrl}/images/generations`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: 'gemini-3-pro-image-preview',
                        prompt: prompt,
                        size: '1024x576',  // 16:9 æ¯”ä¾‹
                        response_format: 'b64_json'
                    })
                });

                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.error?.message || `HTTP ${response.status}`);
                }

                const data = await response.json();

                if (data.data && data.data[0] && data.data[0].b64_json) {
                    const newImage = `data:image/png;base64,${data.data[0].b64_json}`;
                    
                    // æ›´æ–°å›¾ç‰‡
                    shot.generatedImage = newImage;
                    shot.status = 'completed';
                    
                    // æ›´æ–°å¯¹åº”çš„frame
                    scene.gridSheets.forEach(sheet => {
                        const frame = sheet.frames.find(f => f.index === shotIdx);
                        if (frame) {
                            frame.image = newImage;
                        }
                    });
                }
            } catch (error) {
                console.error('å•å¼ ç”Ÿæˆé”™è¯¯:', error);
                alert('ç”Ÿæˆå¤±è´¥: ' + error.message);
                shot.status = 'error';
            } finally {
                shot.isGenerating = false;
                renderCurrentScene();
            }
        }

        async function regenerateCurrentScene() {
            const apiKey = document.getElementById('apiKey').value.trim();
            if (!apiKey) { alert('è¯·è¾“å…¥ API Key'); return; }

            if (confirm('ç¡®å®šè¦é‡æ–°ç”Ÿæˆå½“å‰åœºæ¬¡çš„æ‰€æœ‰åˆ†é•œå—ï¼Ÿ')) {
                scenes[currentSceneIndex].generated = false;
                scenes[currentSceneIndex].gridSheets = [];
                scenes[currentSceneIndex].shots.forEach(s => {
                    s.status = 'pending';
                    s.generatedImage = null;
                });

                await generateScene12Grid(currentSceneIndex, apiKey);
                scenes[currentSceneIndex].generated = true;
                renderScenesList();
                renderCurrentScene();
            }
        }

        function downloadImage(url, filename) {
            const link = document.createElement('a');
            link.href = url;
            link.download = `${filename}.png`;
            link.click();
        }

        function openImageModal(src) {
            const modal = document.getElementById('imageModal');
            document.getElementById('modalImage').src = src;
            modal.classList.add('active');
        }

        function closeImageModal(e) {
            if (e.target.id === 'imageModal') {
                document.getElementById('imageModal').classList.remove('active');
            }
        }

        // åˆå§‹åŒ–
        window.addEventListener('load', () => {
            document.getElementById('apiKey').value = localStorage.getItem('apiyi_key') || '';
        });
        document.getElementById('apiKey').addEventListener('change', (e) => {
            localStorage.setItem('apiyi_key', e.target.value);
        });
    </script>
</body>
</html>
